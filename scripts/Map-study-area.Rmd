---
title: "Map-script"
author: "Anna Talucci"
date: "4/2/2020"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Overview

Skeleton for developing a map figure for FLARE UAS vegetation paper

This script is reliant on
* `Rproj` and therefore the `wd()`does not have to be set
* Relative path names "../folder-name/file-name.ext"
* This script is reliant on the following folders 
    +"../scripts/" --this houses all scripts written in RMarkdown
    +"../data/shapfiles/" --this houses shape files
    +"../figures/
* Please reference the Git Hub repository called **FLARE-UAV-veg** to see the file structure used here

# Packages

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(DT)
library(sf)
library(ggmap) # devtools::install_github("dkahle/ggmap")
library(ggrepel)
library(raster)
library(rgdal)
library(rasterVis)
library(RColorBrewer)
library(cowplot)
library(ggspatial)
library(maps)
library(RStoolbox)
library(mapproj)
```
# Projections 

Russia Equal area projection

```{r}
ee_proj = "+proj=aea +lat_1=50 +lat_2=70 +lat_0=56 +lon_0=100 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs "
```

# Read in shapefile boundaries

We are using relative file path names here. Note the file name is preceded by the sub-folder shapefiles in the data folder.

```{r}
shapefile <- st_read("../data/shapefiles/RUS_adm0.shp") 
```

```{r}
ru_shp <- st_transform(shapefile, CRS(newproj))


```

# Create a bounding box 

Use metadata from all_fires shapefile to identify `xmin`, `xmax`, `ymin`, and `ymax` to define the bounding box

From raster data below:
Show in New WindowClear OutputExpand/Collapse Output
class      : Extent 
xmin       : 159.9998 
xmax       : 163.0002 
ymin       : 67.24968 
ymax       : 69.25023 

```{r}
(insetrect <- data.frame(xmin = 159.9998, xmax = 163.0002, ymin = 67.24968, ymax = 69.25023)) #Replace numeric values
```

# Map Making


## British Columbia with study area bounding box

This map will serve as an inset in the final map. 

**Edit data!!**
```{r}
laea <- "+proj=laea +lat_0=90 +lon_0=0 +x_0=0 +y_0=0 +ellps=WGS84 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs" 



data("wrld_simpl", package = "maptools")                                                                            
wm <- crop(wrld_simpl, extent(-180, 180, 60, 90))                                                                   
plot(wm) 

wm_ee <- spTransform(wm, CRSobj = CRS(laea))
plot(wm_ee)
wm_ee
wm
```
```{r}

```


```{r}
# Defines the x axes required
x_lines <- seq(-120,180, by = 60)

ggplot() +
  geom_polygon(data = wm, aes(x = long, y = lat, group = group), fill = "wheat", colour = "black", alpha = 0.8) +
  
  coord_map("ortho", orientation = c(90, 0, 0)) +
  scale_y_continuous(breaks = seq(60, 90, by = 10), labels = NULL) +

  # Removes Axes and labels
  scale_x_continuous(breaks = NULL) +
  xlab("") + 
  ylab("") +

  # Adds labels
  geom_text(aes(x = 0, y = seq(60, 90, by = 10), hjust = 0.4, vjust = -0.6, label = paste0(seq(60, 90, by = 10), "°N"))) +
  geom_text(aes(x = x_lines, y = 54, label = c("120°W", "60°W", "0°", "60°E", "120°E", "180°W"))) +

  # Adds axes
  geom_hline(aes(yintercept = 60), size = 1)  +
  geom_segment(aes(y = 60, yend = 90, x = x_lines, xend = x_lines), linetype = "dashed") +

# Change theme to remove axes and ticks
  theme_void() +
theme(panel.grid.major = element_line(size = 0.25, linetype = 'dashed', colour = "black"),
      axis.ticks=element_blank()) +
  
  geom_rect(data = insetrect, aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax), alpha = 0, colour = "#000080", size = 1.5, linetype = 1) 



  
```




```{r}
map_inset = ggplot() + 
  geom_sf(data = ru_shp, fill = "#E8E8E8", color = "black") +
  #Use bounding box from above
  geom_rect(data = insetrect, aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax), alpha = 0, colour = "#000080", size = 1.5, linetype = 1) +
  xlab("")+ylab("")+
  coord_sf() +
   theme_void() +
  #add a bounding box so that will border the inset
  theme(panel.background = element_rect(colour = "black", fill = "white", size = 0.5))

map_inset
```

## Map with legend bottom

Here e create a map with a legend box that is placed outside of the map along the bottom. 

**Edit data!!**

```{r}
map_main = ggplot() +
  #add shapefile
  geom_sf(data = bc, aes(fill = "BC", color = "BC")) + 
  #add shapefile
  geom_sf(data = parks, aes(fill = "Parks", color = "Parks"), show.legend = TRUE) + 
  #add shapefile
  geom_sf(data = lakes, aes(fill = "Lakes", color = "Lakes"), show.legend = TRUE, key_glyph = draw_key_rect) + 
  #add shapefile
  geom_sf(data = fire1, fill = NA, aes(color = "Fire1"), size = 1, show.legend = TRUE, key_glyph = draw_key_rect) + 
  #add shapefile
  geom_sf(data = fire2, fill = NA, aes(color = "Fire2"), size = 1, show.legend = TRUE)  +
  #add shapefile
  geom_sf(data = fire3, fill = NA, aes(color = "Fire3"), size = 1, show.legend = TRUE) + 
  #manually define colors with hexcodes 
  scale_color_manual(values = c("BC" = "#E8E8E8", "Parks" = "#C3ECB2", "Lakes" = "#AADAFF", "Fire1" = "#b82b2b", "Fire2" = "#b06f0c", "Fire3" =  "#dd7116"), 
                       labels = c("British Columbia", "Chelaslie fire", "Entiako fire", "Tweedsmuir fire", "Lakes", "Provincial parks"),
                       name = "") + 
  #manual define fill; for no fill NA
  scale_fill_manual(values = c("BC" = "#E8E8E8", "Parks" = "#C3ECB2", "Lakes" = "#AADAFF", "Fire1" = NA, "Fire2" = NA, "Fire3" =  NA), guide=FALSE) + 
  #define coordinates based on shapefile metadata
  coord_sf(crs = "+proj=aea +lat_1=50 +lat_2=58.5 +lat_0=45 +lon_0=-126 +x_0=1000000 +y_0=0 +datum=NAD83 +units=m +no_defs", xlim = c(983000, 1071000), ylim = c(892000, 941000), expand = FALSE)  + 
  #add a scale bar
  annotation_scale(location = "br", width_hint = 0.25, text_size = 12, text_face = NULL, text_family = "serif", text_col = "black") + 
  #add North Arrow
    annotation_north_arrow(location = "br", which_north = "true", 
        pad_x = unit(0.4, "in"), pad_y = unit(0.5, "in"),
        style = north_arrow_nautical(line_width = 1, line_col = "black", fill = c("black", "white"), text_size = 10, text_face = NULL, text_family = "serif", text_col = "black", text_angle = 0)) + 
  #define theme
  theme(axis.text.x = element_text(face = "plain", color = "black", size = 10),
        axis.text.y = element_text(face = "plain", color = "black", size = 10),
        legend.position= "bottom",
        legend.key = element_rect(fill = "white")) 

map_main
```

# Raster

## Raster Stack for 3-band RGB Image

```{r}
kr_stack <- stack("../data/satellite/UAV-veg-image-sentinel.tif")
```

```{r}
extent(kr_stack)
```

## Map with north arrow and scale bar
```{r}
plot_raster = ggplot() + ggRGB(kr_stack, r=1, g=2, b=3, ggLayer = TRUE, coord_equal = TRUE) +
  xlim(159.9998, 163.0002) + ylim(67.24968, 69.25023) +
  
  
  annotation_scale(location = "br", width_hint = 0.25, text_size = 12, text_face = NULL, text_family = "serif", text_col = "black") +
    annotation_north_arrow(location = "tl", which_north = "true", 
        pad_x = unit(0.4, "in"), pad_y = unit(0.5, "in"),
        style = north_arrow_minimal(line_width = 1, line_col = "white", fill = "white", text_size = 10, text_face = NULL, text_family = "serif", text_col = "black")) +
  coord_sf(crs = "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0", xlim = c(159.9998, 163.0002), ylim = c(67.24968, 69.25023), expand = TRUE)

plot_raster

```


# UAV Transect
```{r}
cn_tr1_pt = readOGR("../data/field-spatial/point/cn_tr1_ee_pt.shp", "cn_tr1_ee_pt") 
```

```{r}
cn_tr1_pt
```




point file bbox - xmin: 2141096 ymin: 2497337 xmax: 2141263 ymax: 2497589
[(x_min, y_min), (x_max, y_min), (x_max, y_max), (x_max, y_min), (x_min, y_min)]

data.frame(xmin = 2141096, xmax = 2141263, ymin = 2497337, ymax = 2497589) #Replace numeric values


2141125, 2141260, 2497340, 2497546  (xmin, xmax, ymin, ymax)
```{r}
coords_tr <- matrix(c(2141096, 2497337,
               2141263, 2497337,
                2141263, 2497589,
               2141096, 2497589,
               2141096, 2497337), 
             ncol = 2, byrow = TRUE)

poly_tr = Polygon(coords_tr)
spatpoly_tr = SpatialPolygons(list(Polygons(list(poly_tr), ID = "a")), proj4string=CRS(ee_proj))
plot(spatpoly_tr, axes = TRUE)

```

```{r}
cn_tr1_f15_raster = raster("../data/rgb/CYN_TR1_FL015.tif")
```

```{r}
cn_tr1_f15 = stack("../data/rgb/CYN_TR1_FL015.tif")
```

```{r}
cn_tr1_f15
```

```{r}
f15_crop <- crop(cn_tr1_f15, spatpoly_tr)
```

```{r}
f15_raster_crop = crop(cn_tr1_f15_raster, spatpoly_tr)
```

```{r}
plot(f15_crop)
```

```{r}
plot(cn_tr1_f15_raster)
plot(cn_tr1_pt, add=TRUE)
```

```{r}
plot(cn_tr1_f15) # the plot function lets you view the maps
plot(spatpoly_tr, add=TRUE)
```


```{r}
 ggplot() + ggRGB(f15_crop, r=1, g=2, b=3, ggLayer = TRUE, coord_equal = TRUE)

```



# Combining Maps

We combine our study area map with the inset map for a final map figure


```{r fig.height=4, fig.width=6}
fig_manuscript = ggdraw() +
  #add base map
  draw_plot(map_main) +
  #add inset and define size and location 
  draw_plot(map_inset, x = 0.12, y = 0.32, width = .25, height = .25) 
 
fig_manuscript
```






# Save map as file

Use `ggsave()` to export the map to a file. Note the relative path name. Multiple extensions are available. Width and height are defined for this figure, but should be adjusted for future figures.

**CHANGE FILE NAME!!**

```{r}
ggsave("../figures/MAP-FILE-NAMEt.png", plot = fig_manuscript, width = 6, height = 4, dpi = 600)
```

####
Show in New WindowClear OutputExpand/Collapse Output

Regions defined for each Polygons
R Console

Show in New WindowClear OutputExpand/Collapse Output
Reading layer `RUS_adm0' from data source `E:\AnnaTalucci\R_GitHub\FLARE-UAVs-veg\data\shapefiles\RUS_adm0.shp' using driver `ESRI Shapefile'
Simple feature collection with 1 feature and 70 fields
geometry type:  MULTIPOLYGON
dimension:      XY
bbox:           xmin: -180 ymin: 41.18887 xmax: 180 ymax: 81.85625
epsg (SRID):    4326
proj4string:    +proj=longlat +datum=WGS84 +no_defs
Show in New WindowClear OutputExpand/Collapse Output

Warning: closing unused connection 3 (C:/Users/atalucci/AppData/Local/Temp/Rtmpcz2q2L/raster/r_tmp_2020-05-18_110857_12584_66768.gri)
R Console

Show in New WindowClear OutputExpand/Collapse Output


class       : SpatialPolygonsDataFrame 
features    : 12 
extent      : -3298407, 2506658, -3309081, 3262685  (xmin, xmax, ymin, ymax)
crs         : +proj=laea +lat_0=90 +lon_0=0 +x_0=0 +y_0=0 +ellps=WGS84 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs 
variables   : 11
names       : FIPS, ISO2, ISO3,  UN,           NAME,    AREA,   POP2005, REGION, SUBREGION,      LON,    LAT 
min values  :     ,   AX,  ALA, 124, Aaland Islands,       0,         0,     19,        21, -109.433, 39.622 
max values  :   US,   US,  USA, 840,  United States, 1638094, 299846449,    150,       154,   96.689,  78.83 
class       : SpatialPolygonsDataFrame 
features    : 12 
extent      : -179.999, 179.999, 60, 83.57027  (xmin, xmax, ymin, ymax)
crs         : +proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs +towgs84=0,0,0 
variables   : 11
names       : FIPS, ISO2, ISO3,  UN,           NAME,    AREA,   POP2005, REGION, SUBREGION,      LON,    LAT 
min values  :     ,   AX,  ALA, 124, Aaland Islands,       0,         0,     19,        21, -109.433, 39.622 
max values  :   US,   US,  USA, 840,  United States, 1638094, 299846449,    150,       154,   96.689,  78.83 
R Console
class       : SpatialPolygonsDataFrame 
features    : 12 
extent      : -3298407, 2506658, -3309081, 3262685  (xmin, xmax, ymin, ymax)
crs         : +proj=laea +lat_0=90 +lon_0=0 +x_0=0 +y_0=0 +ellps=WGS84 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs 
variables   : 11
names       : FIPS, ISO2, ISO3,  UN,           NAME,    AREA,   POP2005, REGION, SUBREGION,      LON,    LAT 
min values  :     ,   AX,  ALA, 124, Aaland Islands,       0,         0,     19,        21, -109.433, 39.622 
max values  :   US,   US,  USA, 840,  United States, 1638094, 299846449,    150,       154,   96.689,  78.83 
class       : SpatialPolygonsDataFrame 
features    : 12 
extent      : -179.999, 179.999, 60, 83.57027  (xmin, xmax, ymin, ymax)
crs         : +proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs +towgs84=0,0,0 
variables   : 11
names       : FIPS, ISO2, ISO3,  UN,           NAME,    AREA,   POP2005, REGION, SUBREGION,      LON,    LAT 
min values  :     ,   AX,  ALA, 124, Aaland Islands,       0,         0,     19,        21, -109.433, 39.622 
max values  :   US,   US,  USA, 840,  United States, 1638094, 299846449,    150,       154,   96.689,  78.83 
Show in New WindowClear OutputExpand/Collapse Output
Reading layer `cyn_f15_ee' from data source `E:\AnnaTalucci\R_GitHub\FLARE-UAVs-veg\data\shapefiles\cyn_f15_ee.shp' using driver `ESRI Shapefile'
Simple feature collection with 9 features and 7 fields
geometry type:  POINT
dimension:      XY
bbox:           xmin: 2141096 ymin: 2497337 xmax: 2141263 ymax: 2497589
epsg (SRID):    NA
proj4string:    +proj=aea +lat_1=50 +lat_2=70 +lat_0=56 +lon_0=100 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs
Show in New WindowClear OutputExpand/Collapse Output
class      : Extent 
xmin       : 159.9998 
xmax       : 163.0002 
ymin       : 67.24968 
ymax       : 69.25023 
Show in New WindowClear OutputExpand/Collapse Output


Ignoring unknown parameters: text_size
R Console
	
Scale on map varies by more than 10%, scale bar may be inaccurate

Show in New WindowClear OutputExpand/Collapse Output

Show in New WindowClear OutputExpand/Collapse Output

Show in New WindowClear OutputExpand/Collapse Output
xmin
<dbl>
xmax
<dbl>
ymin
<dbl>
ymax
<dbl>
159.9998	163.0002	67.24968	69.25023	
1 row
Show in New WindowClear OutputExpand/Collapse Output
Error in fortify(data) : object 'bc' not found
Show in New WindowClear OutputExpand/Collapse Output

Show in New WindowClear OutputExpand/Collapse Output
class      : RasterStack 
dimensions : 35602, 36482, 1298832164, 3  (nrow, ncol, ncell, nlayers)
resolution : 0.032888, 0.032888  (x, y)
extent     : 2140583, 2141783, 2496902, 2498073  (xmin, xmax, ymin, ymax)
crs        : +proj=aea +lat_1=50 +lat_2=70 +lat_0=56 +lon_0=100 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs +ellps=WGS84 +towgs84=0,0,0 
names      : CYN_TR1_FL015.1, CYN_TR1_FL015.2, CYN_TR1_FL015.3 
min values :      0.00000000,      0.01415473,      0.05788141 
max values :             255,             255,             255 

Show in New WindowClear OutputExpand/Collapse Output

