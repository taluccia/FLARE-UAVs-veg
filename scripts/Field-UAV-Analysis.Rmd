---
title: "Field and UAv Data Analysis"
author: "Anna Talucci"
date: "2/28/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# Overview

Analysis of field data (proportion of live trees, shrub basal area, and tree basal area)

# Pakcages
```{r}
library(tidyr)
library(dplyr)
library(ggplot2)
library(stringr)
library(lme4)
library(cowplot)
library(lme4)
library(lsmeans)
library(DHARMa)
```


# Field Data
```{r}
field_data = read.csv("../data/field_subset/field_data_all.csv")
```

```{r}
head(field_data)
```

## field Plot sizes

```{r}
field_data %>% group_by(site, transect) %>% 
  summarise(min(shrub_plot_area))
```

```{r}
field_data %>% group_by(site, transect) %>% 
  summarise(max(shrub_plot_area))
```

```{r}
field_data %>% group_by(site, transect) %>% 
  summarise(min(tree_radius))
```

```{r}
field_data %>% group_by(site, transect) %>% 
  summarise(max(tree_radius))
```

# UAV Data

```{r}
gcc_all = read.csv("../data/extracted_data/gcc_all.csv", strip.white = TRUE)
ndvi_all = read.csv("../data/extracted_data/2020-05-20_ndvi_all_pix4D.csv", strip.white = TRUE)
```

```{r}
head(gcc_all)
head(ndvi_all)
```

# Combine Field and UAV data

```{r}
gcc_ndvi = merge(gcc_all, ndvi_all, by="ID")
gcc_ndvi
field_gcc = merge(field_data, gcc_all, by="ID") 
field_gcc
field_gcc_ndvi = merge(field_data, gcc_ndvi,  "ID")
field_gcc_ndvi
```

# burn_year as factor

```{r}
field_gcc$burn_year = as.factor(field_gcc$burn_year)
field_gcc_ndvi$burn_year = as.factor(field_gcc_ndvi$burn_year)

str(field_gcc)
str(field_gcc_ndvi)
```



# Define graph Theme and color Palette 

```{r}
comp_theme = theme_bw() + theme(legend.position = "none") +  
  theme(panel.grid.major = element_blank()) +
    theme(axis.title.y = element_text(size = 11, hjust = 0.5, vjust = 1.1),
        axis.text.x = element_text(size = 10, color = "black"),
        axis.text.y = element_text(size = 10, color = "black"),
        axis.line = element_line(colour = "black"))
```
 
```{r}

reg_theme = theme_bw() + theme(legend.position = "none") +
  theme(plot.margin = unit(c(t = 0.3, r = 0.3, b = 0.3, l = 0.1), "cm")) +
  theme(axis.title.x = element_text(size = 11, hjust = 0.5, vjust = -0.1),
        axis.title.y = element_text(size = 11, hjust = 0.5, vjust = 1.1),
        axis.text.x = element_text(size = 10, color = "black"),
        axis.text.y = element_text(size = 10, color = "black"),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"))

```

```{r}
cbbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
```


# Analysis: 


# Part 3: Vegetation cover

## GCC Models

### 13. Model: GCC proportion of Live trees

```{r}
mod13 = glm(mean_gcc_tree ~ prop_live, data = field_gcc, family = gaussian)
```

#### Residuals with DHARMa
```{r, include=FALSE}
mod13.res = simulateResiduals(fittedModel = mod13, n = 500)
mod13.res$scaledResiduals
mod13.res$scaledResidualsNormal
```

In the plot below we are looking for the points in the QQ plot to fall along the RED linen. In the Residuals vs.predicted plot were are looking for the lines to be relatively horizontal. All looks good. 
```{r}
plotSimulatedResiduals(simulationOutput = mod13.res)
```

```{r}
testDispersion(mod13.res)
```

#### Sumamry
```{r}
summary(mod13)
```

#### Data for graph
```{r}
lsmeans(mod13, ~ prop_live)

```

```{r}
(mod13_graph = data.frame(summary(lsmeans(mod13, ~ prop_live), type = "response")))
```



```{r}
preddat13 = data.frame(prop_live = field_gcc$prop_live)

head(preddat13)

pred13 = predict(mod13, newdata = preddat13, se.fit = TRUE)

UL13 = with(pred13, fit + 2*se.fit)
LL13 = with(pred13, fit - 2*se.fit)

field_gcc13 = mutate(field_gcc, pred13 = pred13$fit, 
               ucl_mod13 = UL13, 
               lcl_mod13 = LL13)
```

```{r}
min(field_gcc$mean_gcc_tree)
mean(field_gcc$tree_area_sampled_m2)
min(field_gcc$tree_area_sampled_m2)
median(field_gcc$tree_area_sampled_m2)
max(field_gcc$tree_area_sampled_m2)
```
#### Graph

```{r}
plot_mod13 = ggplot(data = field_gcc13, aes(x = prop_live, y = mean_gcc_tree)) + 
  geom_point(size = 2) +
    geom_line(aes(y = pred13), linetype = 1, size = 2) + 
    geom_ribbon( aes(ymin = lcl_mod13, ymax = ucl_mod13, color = NULL), alpha = .15) +
    geom_line(aes(y= lcl_mod13), linetype = 'longdash', size = 1) + 
    geom_line(aes(y=ucl_mod13), linetype='longdash', size = 1) +
    ylab("Mean GCC") +
    xlab("Proportion of live trees")  +
    reg_theme +  guides(color=guide_legend(override.aes=list(fill=NA))) 

plot_mod13
```


### 14. Model: GCC tree  BA
```{r}
mod14 = glm(mean_gcc_tree ~ tree_total_ba, data = field_gcc, family = gaussian)
```

#### Residuals with DHARMa
```{r, include=FALSE}
mod14.res = simulateResiduals(fittedModel = mod14, n = 500)
mod14.res$scaledResiduals
mod14.res$scaledResidualsNormal
```

In the plot below we are looking for the points in the QQ plot to fall along the RED linen. In the Residuals vs.predicted plot were are looking for the lines to be relatively horizontal. All looks good. 
```{r}
plotSimulatedResiduals(simulationOutput = mod14.res)
```

```{r}
testDispersion(mod14.res)
```

#### Sumamry
```{r}
summary(mod14)
```

#### Data for graph

```{r}
(mod14_graph = data.frame(summary(lsmeans(mod14, ~ tree_total_ba),type = "response")))
```



```{r}
preddat_mod14 = data.frame(tree_total_ba = field_gcc$tree_total_ba)

head(preddat_mod14)

pred_mod14 = predict(mod14, newdata = preddat_mod14, se.fit = TRUE)

UL_mod14 = with(pred_mod14, fit + 2*se.fit)
LL_mod14 = with(pred_mod14, fit - 2*se.fit)

field_gcc14 = mutate(field_gcc, pred_mod14 = pred_mod14$fit, 
               ucl_mod14 = UL_mod14, 
               lcl_mod14 = LL_mod14)
```

#### Graph

```{r}
plot_mod14 = ggplot(data = field_gcc14, aes(x = tree_total_ba, y = mean_gcc_tree)) + 
  geom_point(size = 2) +
    geom_line(aes(y = pred_mod14), linetype = 1, size = 2) + 
    geom_ribbon( aes(ymin = lcl_mod14, ymax = ucl_mod14, color = NULL, show.legend = FALSE), alpha = .15) +
    geom_line(aes(y= lcl_mod14), linetype = 'longdash', size = 1) + 
    geom_line(aes(y=ucl_mod14), linetype='longdash', size = 1) +
    ylab("Mean GCC") +
    xlab("Tree total basal area" ~(m^2))  +
    reg_theme +  guides(color=guide_legend(override.aes=list(fill=NA))) 

plot_mod14
```

### 15. Model: GCC shrub  BA

```{r}
mod15 = glm(mean_gcc_shrub ~ shrub_total_ba, data = field_gcc, family = gaussian)
```

#### Residuals with DHARMa
```{r, include=FALSE}
mod15.res = simulateResiduals(fittedModel = mod15, n = 500)
mod15.res$scaledResiduals
mod15.res$scaledResidualsNormal
```

In the plot below we are looking for the points in the QQ plot tofall along the RED linen. In the Residuals vs.predicted plot were are looking for the lines to be relatively horizontal. All looks good. 
```{r}
plotSimulatedResiduals(simulationOutput = mod15.res)
```

```{r}
testDispersion(mod15.res)
```

#### Sumamry
```{r}
summary(mod15)
```

#### Data for graph

```{r}
(mod15_graph = data.frame(summary(lsmeans(mod15, ~ shrub_total_ba),type = "response")))
```


```{r}
preddat_mod15 = data.frame(shrub_total_ba = field_gcc$shrub_total_ba)

head(preddat_mod15)

pred_mod15 = predict(mod15, newdata = preddat_mod15, se.fit = TRUE)

UL_mod15 = with(pred_mod15, fit + 2*se.fit)
LL_mod15 = with(pred_mod15, fit - 2*se.fit)

field_gcc15 = mutate(field_gcc, pred_mod15 = pred_mod15$fit, 
               ucl_mod15 = UL_mod15, 
               lcl_mod15 = LL_mod15)
```

#### Graph

```{r}
plot_mod15 = ggplot(data = field_gcc15, aes(x = shrub_total_ba, y = mean_gcc_tree)) +
  geom_point(size = 2) +
    geom_line(aes(y = pred_mod15), linetype = 1, size = 2) + 
    geom_ribbon( aes(ymin = lcl_mod15, ymax = ucl_mod15, color = NULL, show.legend = FALSE), alpha = .15) +
    geom_line(aes(y= lcl_mod15), linetype = 'longdash', size = 1) + 
    geom_line(aes(y=ucl_mod15), linetype='longdash', size = 1) +
    ylab("Mean GCC") +
    xlab("Shrub total basal area" ~(m^2))  +
    reg_theme +  guides(color=guide_legend(override.aes=list(fill=NA))) 

plot_mod15
```




## NDVI Models

### 16. Model: NDVI tree BA

```{r}
mod16 = glm(mean_ndvi_tree ~ tree_total_ba, data = field_gcc_ndvi, family = gaussian)
```

#### Residuals with DHARMa
```{r, include=FALSE}
mod16.res = simulateResiduals(fittedModel = mod16, n = 500)
mod16.res$scaledResiduals
mod16.res$scaledResidualsNormal
```

In the plot below we are looking for the points in the QQ plot to fall along the RED linen. In the Residuals vs.predicted plot were are looking for the lines to be relatively horizontal. All looks good. 
```{r}
plotSimulatedResiduals(simulationOutput = mod16.res)
```

```{r}
testDispersion(mod16.res)
```

#### Sumamry
```{r}
summary(mod16)
```

#### Data for graph

```{r}
(mod16_graph = data.frame(summary(lsmeans(mod16, ~ tree_total_ba),type = "response")))
```


```{r}
preddat_mod16 = data.frame(tree_total_ba = field_gcc_ndvi$tree_total_ba)

head(preddat_mod16)

pred_mod16 = predict(mod16, newdata = preddat_mod16, se.fit = TRUE)

UL_mod16 = with(pred_mod16, fit + 2*se.fit)
LL_mod16 = with(pred_mod16, fit - 2*se.fit)

field_gcc_ndvi16 = mutate(field_gcc_ndvi, pred_mod16 = pred_mod16$fit, 
               ucl_mod16 = UL_mod16, 
               lcl_mod16 = LL_mod16)
```

#### Graph

```{r}
plot_mod16 = ggplot(data = field_gcc_ndvi16, aes(x = tree_total_ba, y = mean_ndvi_tree)) +
  geom_point(size = 2) +
    geom_line(aes(y = pred_mod16), linetype = 1, size = 2) + 
    geom_ribbon( aes(ymin = lcl_mod16, ymax = ucl_mod16, color = NULL, show.legend = FALSE), alpha = .15) +
    geom_line(aes(y= lcl_mod16), linetype = 'longdash', size = 1) + 
    geom_line(aes(y=ucl_mod16), linetype='longdash', size = 1) +
    ylab("Mean NDVI") +
    xlab("Tree total basal area"~(m^2))  +
    reg_theme +  guides(color=guide_legend(override.aes=list(fill=NA))) 

plot_mod16
```

### 17. Model: NDVI shrub BA

```{r}
mod17 = glm(mean_ndvi_shrub ~ shrub_total_ba, data = field_gcc_ndvi, family = gaussian)
```

#### Residuals with DHARMa
```{r, include=FALSE}
mod17.res = simulateResiduals(fittedModel = mod17, n = 500)
mod17.res$scaledResiduals
mod17.res$scaledResidualsNormal
```

In the plot below we are looking for the points in the QQ plot to fall along the RED linen. In the Residuals vs.predicted plot were are looking for the lines to be relatively horizontal. All looks good. 
```{r}
plotSimulatedResiduals(simulationOutput = mod17.res)
```

```{r}
testDispersion(mod17.res)
```

#### Sumamry
```{r}
summary(mod17)
```

#### Data for graph

```{r}
(mod17_graph = data.frame(summary(lsmeans(mod17, ~ shrub_total_ba),type = "response")))
```

```{r}
preddat_mod17 = data.frame(shrub_total_ba = field_gcc_ndvi$shrub_total_ba)

head(preddat_mod17)

pred_mod17 = predict(mod17, newdata = preddat_mod17, se.fit = TRUE)

UL_mod17 = with(pred_mod17, fit + 2*se.fit)
LL_mod17 = with(pred_mod17, fit - 2*se.fit)

field_gcc_ndvi17 = mutate(field_gcc_ndvi, pred_mod17 = pred_mod17$fit, 
               ucl_mod17 = UL_mod17, 
               lcl_mod17 = LL_mod17)
```

#### Graph

```{r}
plot_mod17 = ggplot(data = field_gcc_ndvi17, aes(x = shrub_total_ba, y = mean_ndvi_shrub)) + geom_point(size = 2) +
    geom_line(aes(y = pred_mod17), linetype = 1, size = 2) + 
    geom_ribbon( aes(ymin = lcl_mod17, ymax = ucl_mod17, color = NULL, show.legend = FALSE), alpha = .15) +
    geom_line(aes(y= lcl_mod17), linetype = 'longdash', size = 1) + 
    geom_line(aes(y=ucl_mod17), linetype='longdash', size = 1) +
    ylab("Mean NDVI") +
    xlab("Shrub total basal area" ~(m^2))  +
    reg_theme +  guides(color=guide_legend(override.aes=list(fill=NA))) 

plot_mod17
```


### 18. Model: NDVI proportion of Live trees

```{r}
mod18 = glm(mean_ndvi_tree ~ prop_live, data = field_gcc_ndvi, family = gaussian)
```

#### Residuals with DHARMa
```{r, include=FALSE}
mod18.res = simulateResiduals(fittedModel = mod18, n = 500)
mod18.res$scaledResiduals
mod18.res$scaledResidualsNormal
```

In the plot below we are looking for the points in the QQ plot to fall along the RED linen. In the Residuals vs.predicted plot were are looking for the lines to be relatively horizontal. All looks good. 
```{r}
plotSimulatedResiduals(simulationOutput = mod18.res)
```

```{r}
testDispersion(mod18.res)
```

#### Sumamry
```{r}
summary(mod18)
```

#### Data for graph

```{r}
(mod18_graph = data.frame(summary(lsmeans(mod18, ~ prop_live), type = "response")))
```

```{r}

names(mod18_graph)[5:6] = c("lcl", "ucl")
mod18_graph1 = data.frame(mod18_graph)
mod18_graph1

```

```{r}
preddat18 = data.frame(prop_live = field_gcc_ndvi$prop_live)

head(preddat18)

pred18 = predict(mod18, newdata = preddat18, se.fit = TRUE)

UL18 = with(pred18, fit + 2*se.fit)
LL18 = with(pred18, fit - 2*se.fit)

field_gcc_ndvi18 = mutate(field_gcc_ndvi, pred18 = pred18$fit, 
               ucl_mod18 = UL18, 
               lcl_mod18 = LL18)
```


#### Graph

```{r}
plot_mod18 = ggplot(data = field_gcc_ndvi18, aes(x = prop_live, y = mean_ndvi_tree)) + 
  geom_point(size = 2) +
    geom_line(aes(y = pred18), linetype = 1, size = 2) + 
    geom_ribbon( aes(ymin = lcl_mod18, ymax = ucl_mod18, color = NULL, show.legend = FALSE), alpha = .15) +
    geom_line(aes(y= lcl_mod18), linetype = 'longdash', size = 1) + 
    geom_line(aes(y=ucl_mod18), linetype='longdash', size = 1) +
    ylab("Mean NDVI") +
    xlab("Proportion of live trees")  +
    reg_theme +  guides(color=guide_legend(override.aes=list(fill=NA))) 

plot_mod18
```





# Manuscript Figures 

## Part 3: Vegetation  cover


```{r fig.height=7, fig.width=6}

grid_plot_veg = cowplot::plot_grid(plot_mod13, plot_mod18, plot_mod14, plot_mod16, plot_mod15, plot_mod17,    labels = c("A", "B", "C", "D", "E", "F"), align = "hv", ncol= 2) 
grid_plot_veg

```

```{r eval=FALSE, include=FALSE}
ggsave("../figures/2020-05-20_vegcover-gcc-ndvi.jpeg", plot = grid_plot_veg, width = 6, height = 7, units = c("in"), dpi=600 )
```

