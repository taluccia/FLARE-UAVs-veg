---
title: "Field and UAv Data Analysis"
author: "Anna Talucci"
date: "2/28/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# Overview

Analysis of field data (proportion of live trees, shrub basal area, and tree basal area)

# Pakcages
```{r}
library(tidyr)
library(dplyr)
library(ggplot2)
library(stringr)
library(lme4)
library(cowplot)
library(lme4)
library(lsmeans)
library(DHARMa)
```


# Field Data
```{r}
field_data = read.csv("../data/field_subset/field_data_all.csv")
```

```{r}
head(field_data)
```

## field Plot sizes

```{r}
field_data %>% group_by(site, transect) %>% 
  summarise(min(shrub_plot_area))
```

```{r}
field_data %>% group_by(site, transect) %>% 
  summarise(max(shrub_plot_area))
```

```{r}
field_data %>% group_by(site, transect) %>% 
  summarise(min(tree_radius))
```

```{r}
field_data %>% group_by(site, transect) %>% 
  summarise(max(tree_radius))
```

# UAV Data

```{r}
gcc_all = read.csv("../data/extracted_data/gcc_all.csv", strip.white = TRUE)
ndvi_all = read.csv("../data/extracted_data/2020-05-20_ndvi_all_pix4D.csv", strip.white = TRUE)
```

```{r}
head(gcc_all)
head(ndvi_all)
```

# Combine Field and UAV data

```{r}
gcc_ndvi = merge(gcc_all, ndvi_all, by="ID")
gcc_ndvi
field_gcc = merge(field_data, gcc_all, by="ID") 
field_gcc
field_gcc_ndvi = merge(field_data, gcc_ndvi,  "ID")
field_gcc_ndvi
```

# burn_year as factor

```{r}
field_gcc$burn_year = as.factor(field_gcc$burn_year)
field_gcc_ndvi$burn_year = as.factor(field_gcc_ndvi$burn_year)

str(field_gcc)
str(field_gcc_ndvi)
```



# Define graph Theme and color Palette 

```{r}
comp_theme = theme_bw() + theme(legend.position = "none") +  
  theme(panel.grid.major = element_blank()) +
    theme(axis.title.y = element_text(size = 11, hjust = 0.5, vjust = 1.1),
        axis.text.x = element_text(size = 10, color = "black"),
        axis.text.y = element_text(size = 10, color = "black"),
        axis.line = element_line(colour = "black"))
```
 
```{r}

reg_theme = theme_bw() + theme(legend.position = "none") +
  theme(plot.margin = unit(c(t = 0.3, r = 0.3, b = 0.3, l = 0.1), "cm")) +
  theme(axis.title.x = element_text(size = 11, hjust = 0.5, vjust = -0.1),
        axis.title.y = element_text(size = 11, hjust = 0.5, vjust = 1.1),
        axis.text.x = element_text(size = 10, color = "black"),
        axis.text.y = element_text(size = 10, color = "black"),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"))

```

```{r}
cbbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
```


# Analysis: 


# Part 3: Vegetation cover

## GCC Models

### 13. Model: GCC proportion of Live trees

```{r}
mod13 = glm(mean_gcc_tree ~ prop_live, data = field_gcc, family = gaussian)
```

#### Residuals with DHARMa
```{r, include=FALSE}
mod13.res = simulateResiduals(fittedModel = mod13, n = 500)
mod13.res$scaledResiduals
mod13.res$scaledResidualsNormal
```

In the plot below we are looking for the points in the QQ plot to fall along the RED linen. In the Residuals vs.predicted plot were are looking for the lines to be relatively horizontal. All looks good. 
```{r}
plotSimulatedResiduals(simulationOutput = mod13.res)
```

```{r}
testDispersion(mod13.res)
```

#### Summary
```{r}
summary(mod13)
```
##### Summary Dataframe

```{r}
mod13_df = data.frame(summary(mod13)$coefficients[,], confint(mod13), deviance(mod13), summary(mod13)$null.deviance, extractAIC(mod13))
mod13_df
mod13_df2 = tibble::rownames_to_column(mod13_df, "coefficent")
mod13_df3 = mod13_df2 %>% 
  mutate(model = "mod13") %>% 
  mutate(response = "GCC" ) %>%  
  rename(estimate = Estimate, se = Std..Error, t_value = t.value,  p_value = Pr...t.., lcl = X2.5.., ucl = X97.5.., deviance=deviance.mod13., null_deviance= summary.mod13..null.deviance, AIC = extractAIC.mod13.) %>% dplyr::select(model:response, coefficent:AIC)
mod13_df3
```

#### Data for graph

```{r}
preddat13 = data.frame(prop_live = field_gcc$prop_live)

head(preddat13)

pred13 = predict(mod13, newdata = preddat13, se.fit = TRUE)

UL13 = with(pred13, fit + 2*se.fit)
LL13 = with(pred13, fit - 2*se.fit)

field_gcc13 = mutate(field_gcc, pred13 = pred13$fit, 
               ucl_mod13 = UL13, 
               lcl_mod13 = LL13)
```

```{r}
min(field_gcc$mean_gcc_tree)
mean(field_gcc$tree_area_sampled_m2)
min(field_gcc$tree_area_sampled_m2)
median(field_gcc$tree_area_sampled_m2)
max(field_gcc$tree_area_sampled_m2)
```
#### Graph

```{r}
plot_mod13 = ggplot(data = field_gcc13, aes(x = prop_live, y = mean_gcc_tree)) + 
  geom_point(size = 2) +
    geom_line(aes(y = pred13), linetype = 1, size = 2) + 
    geom_ribbon( aes(ymin = lcl_mod13, ymax = ucl_mod13, color = NULL), alpha = .15) +
    geom_line(aes(y= lcl_mod13), linetype = 'longdash', size = 1) + 
    geom_line(aes(y=ucl_mod13), linetype='longdash', size = 1) +
    ylab("Mean GCC") +
    xlab("Proportion of live trees")  +
    reg_theme +  guides(color=guide_legend(override.aes=list(fill=NA))) 

plot_mod13
```


### 14. Model: GCC tree  BA
```{r}
mod14 = glm(mean_gcc_tree ~ tree_total_ba, data = field_gcc, family = gaussian)
```

#### Residuals with DHARMa
```{r, include=FALSE}
mod14.res = simulateResiduals(fittedModel = mod14, n = 500)
mod14.res$scaledResiduals
mod14.res$scaledResidualsNormal
```

In the plot below we are looking for the points in the QQ plot to fall along the RED linen. In the Residuals vs.predicted plot were are looking for the lines to be relatively horizontal. All looks good. 
```{r}
plotSimulatedResiduals(simulationOutput = mod14.res)
```

```{r}
testDispersion(mod14.res)
```

#### Summary
```{r}
summary(mod14)
```

##### Summary Dataframe

```{r}
mod14_df = data.frame(summary(mod14)$coefficients[,], confint(mod14), deviance(mod14), summary(mod14)$null.deviance, extractAIC(mod14))
mod14_df
mod14_df2 = tibble::rownames_to_column(mod14_df, "coefficent")
mod14_df3 = mod14_df2 %>% 
  mutate(model = "mod14") %>% 
  mutate(response = "GCC" ) %>%  
  rename(estimate = Estimate, se = Std..Error, t_value = t.value,  p_value = Pr...t.., lcl = X2.5.., ucl = X97.5.., deviance=deviance.mod14., null_deviance= summary.mod14..null.deviance, AIC = extractAIC.mod14.) %>% dplyr::select(model:response, coefficent:AIC)
mod14_df3
```

#### Data for graph

```{r}
preddat_mod14 = data.frame(tree_total_ba = field_gcc$tree_total_ba)

head(preddat_mod14)

pred_mod14 = predict(mod14, newdata = preddat_mod14, se.fit = TRUE)

UL_mod14 = with(pred_mod14, fit + 2*se.fit)
LL_mod14 = with(pred_mod14, fit - 2*se.fit)

field_gcc14 = mutate(field_gcc, pred_mod14 = pred_mod14$fit, 
               ucl_mod14 = UL_mod14, 
               lcl_mod14 = LL_mod14)
```

#### Graph

```{r}
plot_mod14 = ggplot(data = field_gcc14, aes(x = tree_total_ba, y = mean_gcc_tree)) + 
  geom_point(size = 2) +
    geom_line(aes(y = pred_mod14), linetype = 1, size = 2) + 
    geom_ribbon( aes(ymin = lcl_mod14, ymax = ucl_mod14, color = NULL, show.legend = FALSE), alpha = .15) +
    geom_line(aes(y= lcl_mod14), linetype = 'longdash', size = 1) + 
    geom_line(aes(y=ucl_mod14), linetype='longdash', size = 1) +
    ylab("Mean GCC") +
    xlab("Tree total basal area" ~(m^2))  +
    reg_theme +  guides(color=guide_legend(override.aes=list(fill=NA))) 

plot_mod14
```

### 15. Model: GCC shrub  BA

```{r}
mod15 = glm(mean_gcc_shrub ~ shrub_total_ba, data = field_gcc, family = gaussian)
```

#### Residuals with DHARMa
```{r, include=FALSE}
mod15.res = simulateResiduals(fittedModel = mod15, n = 500)
mod15.res$scaledResiduals
mod15.res$scaledResidualsNormal
```

In the plot below we are looking for the points in the QQ plot tofall along the RED linen. In the Residuals vs.predicted plot were are looking for the lines to be relatively horizontal. All looks good. 
```{r}
plotSimulatedResiduals(simulationOutput = mod15.res)
```

```{r}
testDispersion(mod15.res)
```

#### Summary
```{r}
summary(mod15)
```

##### Summary Dataframe

```{r}
mod15_df = data.frame(summary(mod15)$coefficients[,], confint(mod15), deviance(mod15), summary(mod15)$null.deviance, extractAIC(mod15))
mod15_df
mod15_df2 = tibble::rownames_to_column(mod15_df, "coefficent")
mod15_df3 = mod15_df2 %>% 
  mutate(model = "mod15") %>% 
  mutate(response = "GCC" ) %>%  
  rename(estimate = Estimate, se = Std..Error, t_value = t.value,  p_value = Pr...t.., lcl = X2.5.., ucl = X97.5.., deviance=deviance.mod15., null_deviance= summary.mod15..null.deviance, AIC = extractAIC.mod15.) %>% dplyr::select(model:response, coefficent:AIC)
mod15_df3
```

#### Data for graph

```{r}
preddat_mod15 = data.frame(shrub_total_ba = field_gcc$shrub_total_ba)

head(preddat_mod15)

pred_mod15 = predict(mod15, newdata = preddat_mod15, se.fit = TRUE)

UL_mod15 = with(pred_mod15, fit + 2*se.fit)
LL_mod15 = with(pred_mod15, fit - 2*se.fit)

field_gcc15 = mutate(field_gcc, pred_mod15 = pred_mod15$fit, 
               ucl_mod15 = UL_mod15, 
               lcl_mod15 = LL_mod15)
```

#### Graph

```{r}
plot_mod15 = ggplot(data = field_gcc15, aes(x = shrub_total_ba, y = mean_gcc_tree)) +
  geom_point(size = 2) +
    geom_line(aes(y = pred_mod15), linetype = 1, size = 2) + 
    geom_ribbon( aes(ymin = lcl_mod15, ymax = ucl_mod15, color = NULL, show.legend = FALSE), alpha = .15) +
    geom_line(aes(y= lcl_mod15), linetype = 'longdash', size = 1) + 
    geom_line(aes(y=ucl_mod15), linetype='longdash', size = 1) +
    ylab("Mean GCC") +
    xlab("Shrub total basal area" ~(m^2))  +
    reg_theme +  guides(color=guide_legend(override.aes=list(fill=NA))) 

plot_mod15
```




## NDVI Models

### 16. Model: NDVI tree BA

```{r}
mod16 = glm(mean_ndvi_tree ~ tree_total_ba, data = field_gcc_ndvi, family = gaussian)
```

#### Residuals with DHARMa
```{r, include=FALSE}
mod16.res = simulateResiduals(fittedModel = mod16, n = 500)
mod16.res$scaledResiduals
mod16.res$scaledResidualsNormal
```

In the plot below we are looking for the points in the QQ plot to fall along the RED linen. In the Residuals vs.predicted plot were are looking for the lines to be relatively horizontal. All looks good. 
```{r}
plotSimulatedResiduals(simulationOutput = mod16.res)
```

```{r}
testDispersion(mod16.res)
```

#### Summary
```{r}
summary(mod16)
```
##### Summary Dataframe

```{r}
mod16_df = data.frame(summary(mod16)$coefficients[,], confint(mod16), deviance(mod16), summary(mod16)$null.deviance, extractAIC(mod16))
mod16_df
mod16_df2 = tibble::rownames_to_column(mod16_df, "coefficent")
mod16_df3 = mod16_df2 %>% 
  mutate(model = "mod16") %>% 
  mutate(response = "NDVI" ) %>%  
  rename(estimate = Estimate, se = Std..Error, t_value = t.value,  p_value = Pr...t.., lcl = X2.5.., ucl = X97.5.., deviance=deviance.mod16., null_deviance= summary.mod16..null.deviance, AIC = extractAIC.mod16.) %>% dplyr::select(model:response, coefficent:AIC)
mod16_df3
```

#### Data for graph

```{r}
preddat_mod16 = data.frame(tree_total_ba = field_gcc_ndvi$tree_total_ba)

head(preddat_mod16)

pred_mod16 = predict(mod16, newdata = preddat_mod16, se.fit = TRUE)

UL_mod16 = with(pred_mod16, fit + 2*se.fit)
LL_mod16 = with(pred_mod16, fit - 2*se.fit)

field_gcc_ndvi16 = mutate(field_gcc_ndvi, pred_mod16 = pred_mod16$fit, 
               ucl_mod16 = UL_mod16, 
               lcl_mod16 = LL_mod16)
```

#### Graph

```{r}
plot_mod16 = ggplot(data = field_gcc_ndvi16, aes(x = tree_total_ba, y = mean_ndvi_tree)) +
  geom_point(size = 2) +
    geom_line(aes(y = pred_mod16), linetype = 1, size = 2) + 
    geom_ribbon( aes(ymin = lcl_mod16, ymax = ucl_mod16, color = NULL, show.legend = FALSE), alpha = .15) +
    geom_line(aes(y= lcl_mod16), linetype = 'longdash', size = 1) + 
    geom_line(aes(y=ucl_mod16), linetype='longdash', size = 1) +
    ylab("Mean NDVI") +
    xlab("Tree total basal area"~(m^2))  +
    reg_theme +  guides(color=guide_legend(override.aes=list(fill=NA))) 

plot_mod16
```

### 17. Model: NDVI shrub BA

```{r}
mod17 = glm(mean_ndvi_shrub ~ shrub_total_ba, data = field_gcc_ndvi, family = gaussian)
```

#### Residuals with DHARMa
```{r, include=FALSE}
mod17.res = simulateResiduals(fittedModel = mod17, n = 500)
mod17.res$scaledResiduals
mod17.res$scaledResidualsNormal
```

In the plot below we are looking for the points in the QQ plot to fall along the RED linen. In the Residuals vs.predicted plot were are looking for the lines to be relatively horizontal. All looks good. 
```{r}
plotSimulatedResiduals(simulationOutput = mod17.res)
```

```{r}
testDispersion(mod17.res)
```

#### Summary
```{r}
summary(mod17)
```

##### Summary Dataframe

```{r}
mod17_df = data.frame(summary(mod17)$coefficients[,], confint(mod17), deviance(mod17), summary(mod17)$null.deviance, extractAIC(mod17))
mod17_df
mod17_df2 = tibble::rownames_to_column(mod17_df, "coefficent")
mod17_df3 = mod17_df2 %>% 
  mutate(model = "mod17") %>% 
  mutate(response = "NDVI" ) %>%  
  rename(estimate = Estimate, se = Std..Error, t_value = t.value,  p_value = Pr...t.., lcl = X2.5.., ucl = X97.5.., deviance=deviance.mod17., null_deviance= summary.mod17..null.deviance, AIC = extractAIC.mod17.) %>% dplyr::select(model:response, coefficent:AIC)
mod17_df3
```
#### Data for graph


```{r}
preddat_mod17 = data.frame(shrub_total_ba = field_gcc_ndvi$shrub_total_ba)

head(preddat_mod17)

pred_mod17 = predict(mod17, newdata = preddat_mod17, se.fit = TRUE)

UL_mod17 = with(pred_mod17, fit + 2*se.fit)
LL_mod17 = with(pred_mod17, fit - 2*se.fit)

field_gcc_ndvi17 = mutate(field_gcc_ndvi, pred_mod17 = pred_mod17$fit, 
               ucl_mod17 = UL_mod17, 
               lcl_mod17 = LL_mod17)
```

#### Graph

```{r}
plot_mod17 = ggplot(data = field_gcc_ndvi17, aes(x = shrub_total_ba, y = mean_ndvi_shrub)) + geom_point(size = 2) +
    geom_line(aes(y = pred_mod17), linetype = 1, size = 2) + 
    geom_ribbon( aes(ymin = lcl_mod17, ymax = ucl_mod17, color = NULL, show.legend = FALSE), alpha = .15) +
    geom_line(aes(y= lcl_mod17), linetype = 'longdash', size = 1) + 
    geom_line(aes(y=ucl_mod17), linetype='longdash', size = 1) +
    ylab("Mean NDVI") +
    xlab("Shrub total basal area" ~(m^2))  +
    reg_theme +  guides(color=guide_legend(override.aes=list(fill=NA))) 

plot_mod17
```


### 18. Model: NDVI proportion of Live trees

```{r}
mod18 = glm(mean_ndvi_tree ~ prop_live, data = field_gcc_ndvi, family = gaussian)
```

#### Residuals with DHARMa
```{r, include=FALSE}
mod18.res = simulateResiduals(fittedModel = mod18, n = 500)
mod18.res$scaledResiduals
mod18.res$scaledResidualsNormal
```

In the plot below we are looking for the points in the QQ plot to fall along the RED linen. In the Residuals vs.predicted plot were are looking for the lines to be relatively horizontal. All looks good. 
```{r}
plotSimulatedResiduals(simulationOutput = mod18.res)
```

```{r}
testDispersion(mod18.res)
```

#### Summary
```{r}
summary(mod18)
```

##### Summary Dataframe

```{r}
mod18_df = data.frame(summary(mod18)$coefficients[,], confint(mod18), deviance(mod18), summary(mod18)$null.deviance, extractAIC(mod18))
mod18_df
mod18_df2 = tibble::rownames_to_column(mod18_df, "coefficent")
mod18_df3 = mod18_df2 %>% 
  mutate(model = "mod18") %>% 
  mutate(response = "NDVI" ) %>%  
  rename(estimate = Estimate, se = Std..Error, t_value = t.value,  p_value = Pr...t.., lcl = X2.5.., ucl = X97.5.., deviance=deviance.mod18., null_deviance= summary.mod18..null.deviance, AIC = extractAIC.mod18.) %>% dplyr::select(model:response, coefficent:AIC)
mod18_df3
```

#### Data for graph

```{r}
preddat18 = data.frame(prop_live = field_gcc_ndvi$prop_live)

head(preddat18)

pred18 = predict(mod18, newdata = preddat18, se.fit = TRUE)

UL18 = with(pred18, fit + 2*se.fit)
LL18 = with(pred18, fit - 2*se.fit)

field_gcc_ndvi18 = mutate(field_gcc_ndvi, pred18 = pred18$fit, 
               ucl_mod18 = UL18, 
               lcl_mod18 = LL18)
```


#### Graph

```{r}
plot_mod18 = ggplot(data = field_gcc_ndvi18, aes(x = prop_live, y = mean_ndvi_tree)) + 
  geom_point(size = 2) +
    geom_line(aes(y = pred18), linetype = 1, size = 2) + 
    geom_ribbon( aes(ymin = lcl_mod18, ymax = ucl_mod18, color = NULL, show.legend = FALSE), alpha = .15) +
    geom_line(aes(y= lcl_mod18), linetype = 'longdash', size = 1) + 
    geom_line(aes(y=ucl_mod18), linetype='longdash', size = 1) +
    ylab("Mean NDVI") +
    xlab("Proportion of live trees")  +
    reg_theme +  guides(color=guide_legend(override.aes=list(fill=NA))) 

plot_mod18
```



# Combine Summary output 

```{r}
model_sum1 = rbind(mod13_df3, mod14_df3)
model_sum2 = rbind(mod15_df3, mod16_df3)
model_sum3 = rbind(mod17_df3, mod18_df3)
model_sum4 = rbind(model_sum1, model_sum2)
model_sum5 = rbind(model_sum4, model_sum3)
model_sum5
```

```{r}
write.csv(model_sum5, '../outputs/model_summary/2020-05-27_vegetation-cover-gcc-ndvi.csv', row.names = F)

```


# Manuscript Figures 

## Part 3: Vegetation  cover


```{r fig.height=7, fig.width=6}

grid_plot_veg = cowplot::plot_grid(plot_mod13, plot_mod18, plot_mod14, plot_mod16, plot_mod15, plot_mod17,    labels = c("A", "B", "C", "D", "E", "F"), align = "hv", ncol= 2) 
grid_plot_veg

```

```{r eval=FALSE, include=FALSE}
ggsave("../figures/2020-05-20_vegcover-gcc-ndvi.jpeg", plot = grid_plot_veg, width = 6, height = 7, units = c("in"), dpi=600 )
```


```{r fig.height=7, fig.width=6}

grid_plot_veg1 = cowplot::plot_grid(plot_mod13, plot_mod18, plot_mod14, plot_mod16, plot_mod15, plot_mod17,    labels = c("A", "B", "C", "D", "E", "F"), align = "hv", ncol= 2) +
  draw_label("*", x = .95, y = .76, size = 36, fontface = "bold") +
  draw_label("*", x = .45, y = .76, size = 36, fontface = "bold") +
  draw_label("*", x = .45, y = .10, size = 36, fontface = "bold")
grid_plot_veg1

```

```{r eval=FALSE, include=FALSE}
ggsave("../figures/2020-06-02_vegcover-gcc-ndvi_sig.jpeg", plot = grid_plot_veg1, width = 6, height = 7, units = c("in"), dpi=600 )
```