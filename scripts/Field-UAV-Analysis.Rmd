---
title: "Field and UAv Data Analysis"
author: "Anna Talucci"
date: "2/28/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# Overview

Analysis of field data (proportion of live trees, shrub basal area, and tree basal area)

# Pakcages
```{r}
library(tidyr)
library(dplyr)
library(ggplot2)
library(stringr)
library(lme4)
library(cowplot)
library(lme4)
library(lsmeans)
library(DHARMa)
```


# Field Data
```{r}
field_data = read.csv("../data/field_subset/field_data_all.csv")
```

```{r}
head(field_data)
```

## field Plot sizes

```{r}
field_data %>% group_by(site, transect) %>% 
  summarise(min(shrub_plot_area))
```

```{r}
field_data %>% group_by(site, transect) %>% 
  summarise(max(shrub_plot_area))
```

```{r}
field_data %>% group_by(site, transect) %>% 
  summarise(min(tree_radius))
```

```{r}
field_data %>% group_by(site, transect) %>% 
  summarise(max(tree_radius))
```

# UAV Data

```{r}
gcc_all = read.csv("../data/extracted_data/gcc_all.csv", strip.white = TRUE)
ndvi_all = read.csv("../data/extracted_data/2020-05-20_ndvi_all_pix4D.csv", strip.white = TRUE)
```

```{r}
head(gcc_all)
head(ndvi_all)
```

# Combine Field and UAV data

```{r}
gcc_ndvi = merge(gcc_all, ndvi_all, by="ID")
gcc_ndvi
field_gcc = merge(field_data, gcc_all, by="ID") 
field_gcc
field_gcc_ndvi = merge(field_data, gcc_ndvi,  "ID")
field_gcc_ndvi
```

# burn_year as factor

```{r}
field_gcc$burn_year = as.factor(field_gcc$burn_year)
field_gcc_ndvi$burn_year = as.factor(field_gcc_ndvi$burn_year)

str(field_gcc)
str(field_gcc_ndvi)
```



# Define graph Theme and color Palette 

```{r}
comp_theme = theme_bw() + theme(legend.position = "none") +  
  theme(panel.grid.major = element_blank()) +
    theme(axis.title.y = element_text(size = 11, hjust = 0.5, vjust = 1.1),
        axis.text.x = element_text(size = 10, color = "black"),
        axis.text.y = element_text(size = 10, color = "black"),
        axis.line = element_line(colour = "black"))
```
 
```{r}

reg_theme = theme_bw() + theme(legend.position = "none") +
  theme(plot.margin = unit(c(t = 0.3, r = 0.3, b = 0.3, l = 0.1), "cm")) +
  theme(axis.title.x = element_text(size = 11, hjust = 0.5, vjust = -0.1),
        axis.title.y = element_text(size = 11, hjust = 0.5, vjust = 1.1),
        axis.text.x = element_text(size = 10, color = "black"),
        axis.text.y = element_text(size = 10, color = "black"),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"))

```

```{r}
cbbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
```

# Analysis: 

# Part 3: Vegetation cover

```{r}
head(field_gcc)
head(field_gcc_ndvi)
```


## GCC Models


### 1. Model: tree  BA
live_tree_ba_ha
mean_gcc_tree ~ live_tree_ba
```{r}
mod14 = glm(mean_gcc_10m ~ live_tree_ba_ha, data = field_gcc, family = gaussian)
```

```{r}
fit1 = lm(mean_gcc_10m ~ live_tree_ba_ha, data = field_gcc)
```

#### Residuals with DHARMa
```{r, include=FALSE}
mod14.res = simulateResiduals(fittedModel = mod14, n = 500)
mod14.res$scaledResiduals
mod14.res$scaledResidualsNormal
```

In the plot below we are looking for the points in the QQ plot to fall along the RED linen. In the Residuals vs.predicted plot were are looking for the lines to be relatively horizontal. All looks good. 
```{r}
plotSimulatedResiduals(simulationOutput = mod14.res)
```

```{r}
testDispersion(mod14.res)
```

#### Summary
```{r}
summary(mod14)
```
```{r}
summary(fit1)
```

##### Summary Dataframe

```{r}
mod14_df = data.frame(summary(mod14)$coefficients[,], confint(mod14), deviance(mod14), summary(mod14)$null.deviance, extractAIC(mod14))
mod14_df
mod14_df2 = tibble::rownames_to_column(mod14_df, "coefficent")
mod14_df3 = mod14_df2 %>% 
  mutate(model = "mod14_tree_ba") %>% 
  mutate(response = "GCC" ) %>%  
  rename(estimate = Estimate, se = Std..Error, t_value = t.value,  p_value = Pr...t.., lcl = X2.5.., ucl = X97.5.., deviance=deviance.mod14., null_deviance= summary.mod14..null.deviance, AIC = extractAIC.mod14.) %>% dplyr::select(model:response, coefficent:AIC)
mod14_df3
```
#### lm summary
```{r}
fit1_df = data.frame(summary(fit1)$coefficients[,], confint(fit1), extractAIC(fit1))
fit1_df
fit1_df2 = tibble::rownames_to_column(fit1_df, "coefficent")
fit1_df3 = fit1_df2 %>% 
  mutate(model = "fit1_tree_ba") %>% 
  mutate(response = "GCC" ) %>%  
  mutate(rmse = RMSE(fit1)) %>%
  rename(estimate = Estimate, se = Std..Error, t_value = t.value,  p_value = Pr...t.., lcl = X2.5.., ucl = X97.5.., AIC = extractAIC.fit1.) %>% dplyr::select(model:response, coefficent:rmse)
fit1_df3
```
#### Data for graph

```{r}
preddat_mod14 = data.frame(live_tree_ba_ha = field_gcc$live_tree_ba_ha)

head(preddat_mod14)

pred_mod14 = predict(mod14, newdata = preddat_mod14, se.fit = TRUE)

UL_mod14 = with(pred_mod14, fit + 2*se.fit)
LL_mod14 = with(pred_mod14, fit - 2*se.fit)

field_gcc14 = mutate(field_gcc, pred_mod14 = pred_mod14$fit, 
               ucl_mod14 = UL_mod14, 
               lcl_mod14 = LL_mod14)
```
#### Graph lm
```{r}
p1 = ggplot(data = field_gcc, aes(x = live_tree_ba_ha, y = mean_gcc_10m)) + 
    geom_point(size = 2) +  
  stat_smooth(method = "lm", col = "black", alpha = .25) +
    
    ylab("Mean GCC") +
    labs(x=expression(Live~tree~BA~(m^2/ha))) +
    reg_theme +  guides(color=guide_legend(override.aes=list(fill=NA))) 

p1
  
```


#### Graph glm

```{r}
plot_mod14 = ggplot(data = field_gcc14, aes(x = live_tree_ba_ha, y = mean_gcc_10m)) + 
  geom_point(size = 2) +
    geom_line(aes(y = pred_mod14), linetype = 1, size = 2) + 
    geom_ribbon( aes(ymin = lcl_mod14, ymax = ucl_mod14, color = NULL, show.legend = FALSE), alpha = .15) +
    geom_line(aes(y= lcl_mod14), linetype = 'longdash', size = 1) + 
    geom_line(aes(y=ucl_mod14), linetype='longdash', size = 1) +
    ylab("Mean GCC") +
    labs(x=expression(Live~tree~BA~(m^2/ha))) +
    reg_theme +  guides(color=guide_legend(override.aes=list(fill=NA))) 

plot_mod14
```


### 2. Model: shrub  BA

```{r}
mod15 = glm(mean_gcc_10m ~ shrub_ba_ha, data = field_gcc, family = gaussian)
```

```{r}
fit2 = lm(mean_gcc_10m ~ shrub_ba_ha, data = field_gcc)
```

#### Residuals with DHARMa
```{r, include=FALSE}
mod15.res = simulateResiduals(fittedModel = mod15, n = 500)
mod15.res$scaledResiduals
mod15.res$scaledResidualsNormal
```

In the plot below we are looking for the points in the QQ plot tofall along the RED linen. In the Residuals vs.predicted plot were are looking for the lines to be relatively horizontal. All looks good. 
```{r}
plotSimulatedResiduals(simulationOutput = mod15.res)
```

```{r}
testDispersion(mod15.res)
```

#### Summary
```{r}
summary(mod15)
```

##### Summary Dataframe

```{r}
mod15_df = data.frame(summary(mod15)$coefficients[,], confint(mod15), deviance(mod15), summary(mod15)$null.deviance, extractAIC(mod15))
mod15_df
mod15_df2 = tibble::rownames_to_column(mod15_df, "coefficent")
mod15_df3 = mod15_df2 %>% 
  mutate(model = "mod15_shrub_ba") %>% 
  mutate(response = "GCC" ) %>%  
  rename(estimate = Estimate, se = Std..Error, t_value = t.value,  p_value = Pr...t.., lcl = X2.5.., ucl = X97.5.., deviance=deviance.mod15., null_deviance= summary.mod15..null.deviance, AIC = extractAIC.mod15.) %>% dplyr::select(model:response, coefficent:AIC)
mod15_df3
```
#### lm summary
```{r}
fit2_df = data.frame(summary(fit2)$coefficients[,], confint(fit2), extractAIC(fit2))
fit2_df
fit2_df2 = tibble::rownames_to_column(fit2_df, "coefficent")
fit2_df3 = fit2_df2 %>% 
  mutate(model = "fit2_shrub_ba") %>% 
  mutate(response = "GCC" ) %>%  
  mutate(rmse = RMSE(fit2)) %>%
  rename(estimate = Estimate, se = Std..Error, t_value = t.value,  p_value = Pr...t.., lcl = X2.5.., ucl = X97.5.., AIC = extractAIC.fit2.) %>% dplyr::select(model:response, coefficent:rmse)
fit2_df3
```

#### Data for graph

```{r}
preddat_mod15 = data.frame(shrub_ba_ha = field_gcc$shrub_ba_ha)

head(preddat_mod15)

pred_mod15 = predict(mod15, newdata = preddat_mod15, se.fit = TRUE)

UL_mod15 = with(pred_mod15, fit + 2*se.fit)
LL_mod15 = with(pred_mod15, fit - 2*se.fit)

field_gcc15 = mutate(field_gcc, pred_mod15 = pred_mod15$fit, 
               ucl_mod15 = UL_mod15, 
               lcl_mod15 = LL_mod15)
```

#### Graph lm
```{r}
p2 = ggplot(data = field_gcc, aes(x = shrub_ba_ha, y = mean_gcc_10m)) + 
    geom_point(size = 2) +  
  stat_smooth(method = "lm", col = "black", alpha = .25) +
    
    ylab("Mean GCC") +
    labs(x=expression(Shrub~BA~(m^2/ha))) +
    reg_theme +  guides(color=guide_legend(override.aes=list(fill=NA))) 

p2
  
```

#### Graph glm

```{r}
plot_mod15 = ggplot(data = field_gcc15, aes(x = shrub_ba_ha, y = mean_gcc_10m)) +
  geom_point(size = 2) +
    geom_line(aes(y = pred_mod15), linetype = 1, size = 2) + 
    geom_ribbon( aes(ymin = lcl_mod15, ymax = ucl_mod15, color = NULL, show.legend = FALSE), alpha = .15) +
    geom_line(aes(y= lcl_mod15), linetype = 'longdash', size = 1) + 
    geom_line(aes(y=ucl_mod15), linetype='longdash', size = 1) +
    ylab("Mean GCC") +
    labs(x=expression(Shrub~BA~(m^2/ha))) +
    reg_theme +  guides(color=guide_legend(override.aes=list(fill=NA))) 

plot_mod15
```




## NDVI Models

### 3. Model: tree BA
mean_ndvi_tree ~ live_tree_ba

```{r}
mod16 = glm(mean_ndvi_10m ~ live_tree_ba_ha, data = field_gcc_ndvi, family = gaussian)
```

```{r}
fit3 = glm(mean_ndvi_10m ~ live_tree_ba_ha, data = field_gcc_ndvi)
```

#### Residuals with DHARMa
```{r, include=FALSE}
mod16.res = simulateResiduals(fittedModel = mod16, n = 500)
mod16.res$scaledResiduals
mod16.res$scaledResidualsNormal
```

In the plot below we are looking for the points in the QQ plot to fall along the RED linen. In the Residuals vs.predicted plot were are looking for the lines to be relatively horizontal. All looks good. 
```{r}
plotSimulatedResiduals(simulationOutput = mod16.res)
```

```{r}
testDispersion(mod16.res)
```

#### Summary
```{r}
summary(mod16)
```
##### Summary Dataframe

```{r}
mod16_df = data.frame(summary(mod16)$coefficients[,], confint(mod16), deviance(mod16), summary(mod16)$null.deviance, extractAIC(mod16))
mod16_df
mod16_df2 = tibble::rownames_to_column(mod16_df, "coefficent")
mod16_df3 = mod16_df2 %>% 
  mutate(model = "mod16_tree_ba") %>% 
  mutate(response = "NDVI" ) %>%  
  rename(estimate = Estimate, se = Std..Error, t_value = t.value,  p_value = Pr...t.., lcl = X2.5.., ucl = X97.5.., deviance=deviance.mod16., null_deviance= summary.mod16..null.deviance, AIC = extractAIC.mod16.) %>% dplyr::select(model:response, coefficent:AIC)
mod16_df3
```

#### lm summary
```{r}
fit3_df = data.frame(summary(fit3)$coefficients[,], confint(fit3), extractAIC(fit3))
fit3_df
fit3_df2 = tibble::rownames_to_column(fit3_df, "coefficent")
fit3_df3 = fit3_df2 %>% 
  mutate(model = "fit3_tree_ba") %>% 
  mutate(response = "NDVI" ) %>%  
  mutate(rmse = RMSE(fit3)) %>%
  rename(estimate = Estimate, se = Std..Error, t_value = t.value,  p_value = Pr...t.., lcl = X2.5.., ucl = X97.5.., AIC = extractAIC.fit3.) %>% dplyr::select(model:response, coefficent:rmse)
fit3_df3
```
#### Data for graph

```{r}
preddat_mod16 = data.frame(live_tree_ba_ha = field_gcc_ndvi$live_tree_ba_ha)

head(preddat_mod16)

pred_mod16 = predict(mod16, newdata = preddat_mod16, se.fit = TRUE)

UL_mod16 = with(pred_mod16, fit + 2*se.fit)
LL_mod16 = with(pred_mod16, fit - 2*se.fit)

field_gcc_ndvi16 = mutate(field_gcc_ndvi, pred_mod16 = pred_mod16$fit, 
               ucl_mod16 = UL_mod16, 
               lcl_mod16 = LL_mod16)
```

#### Graph lm
```{r}
p3 = ggplot(data = field_gcc_ndvi, aes(x = live_tree_ba_ha, y = mean_ndvi_10m)) + 
    geom_point(size = 2) +  
  stat_smooth(method = "lm", col = "black", alpha = .25) +
    
    ylab("Mean NDVI") +
    labs(x=expression(Live~tree~BA~(m^2/ha))) +
    reg_theme +  guides(color=guide_legend(override.aes=list(fill=NA))) 

p3
  
```

#### Graph glm
```{r}
plot_mod16 = ggplot(data = field_gcc_ndvi16, aes(x = live_tree_ba_ha, y = mean_ndvi_10m)) +
  geom_point(size = 2) +
    geom_line(aes(y = pred_mod16), linetype = 1, size = 2) + 
    geom_ribbon( aes(ymin = lcl_mod16, ymax = ucl_mod16, color = NULL, show.legend = FALSE), alpha = .15) +
    geom_line(aes(y= lcl_mod16), linetype = 'longdash', size = 1) + 
    geom_line(aes(y=ucl_mod16), linetype='longdash', size = 1) +
    ylab("Mean NDVI") +
    labs(x=expression(Live~tree~BA~(m^2/ha))) +
    reg_theme +  guides(color=guide_legend(override.aes=list(fill=NA))) 

plot_mod16
```

### 4. Model: shrub BA

```{r}
mod17 = glm(mean_ndvi_10m ~ shrub_ba_ha, data = field_gcc_ndvi, family = gaussian)
```

```{r}
fit4 = glm(mean_ndvi_10m ~ shrub_ba_ha, data = field_gcc_ndvi)
```

#### Residuals with DHARMa
```{r, include=FALSE}
mod17.res = simulateResiduals(fittedModel = mod17, n = 500)
mod17.res$scaledResiduals
mod17.res$scaledResidualsNormal
```

In the plot below we are looking for the points in the QQ plot to fall along the RED linen. In the Residuals vs.predicted plot were are looking for the lines to be relatively horizontal. All looks good. 
```{r}
plotSimulatedResiduals(simulationOutput = mod17.res)
```

```{r}
testDispersion(mod17.res)
```

#### Summary
```{r}
summary(mod17)
```

##### Summary Dataframe

```{r}
mod17_df = data.frame(summary(mod17)$coefficients[,], confint(mod17), deviance(mod17), summary(mod17)$null.deviance, extractAIC(mod17))
mod17_df
mod17_df2 = tibble::rownames_to_column(mod17_df, "coefficent")
mod17_df3 = mod17_df2 %>% 
  mutate(model = "mod17_shrub_ba") %>% 
  mutate(response = "NDVI" ) %>%  
  rename(estimate = Estimate, se = Std..Error, t_value = t.value,  p_value = Pr...t.., lcl = X2.5.., ucl = X97.5.., deviance=deviance.mod17., null_deviance= summary.mod17..null.deviance, AIC = extractAIC.mod17.) %>% dplyr::select(model:response, coefficent:AIC)
mod17_df3
```

#### lm summary
```{r}
fit4_df = data.frame(summary(fit4)$coefficients[,], confint(fit4), extractAIC(fit4))
fit4_df
fit4_df2 = tibble::rownames_to_column(fit4_df, "coefficent")
fit4_df3 = fit4_df2 %>% 
  mutate(model = "fit4_shrub_ba") %>% 
  mutate(response = "NDVI" ) %>%  
  mutate(rmse = RMSE(fit4)) %>%
  rename(estimate = Estimate, se = Std..Error, t_value = t.value,  p_value = Pr...t.., lcl = X2.5.., ucl = X97.5.., AIC = extractAIC.fit4.) %>% dplyr::select(model:response, coefficent:rmse)
fit4_df3
```

#### Data for graph


```{r}
preddat_mod17 = data.frame(shrub_ba_ha = field_gcc_ndvi$shrub_ba_ha)

head(preddat_mod17)

pred_mod17 = predict(mod17, newdata = preddat_mod17, se.fit = TRUE)

UL_mod17 = with(pred_mod17, fit + 2*se.fit)
LL_mod17 = with(pred_mod17, fit - 2*se.fit)

field_gcc_ndvi17 = mutate(field_gcc_ndvi, pred_mod17 = pred_mod17$fit, 
               ucl_mod17 = UL_mod17, 
               lcl_mod17 = LL_mod17)
```

#### Graph lm

```{r}
p4 = ggplot(data = field_gcc_ndvi, aes(x = shrub_ba_ha, y = mean_ndvi_10m)) + 
    geom_point(size = 2) +  
  stat_smooth(method = "lm", col = "black", alpha = .25) +
    
    ylab("Mean NDVI") +
    labs(x=expression(Shrub~BA~(m^2/ha))) +
    reg_theme +  guides(color=guide_legend(override.aes=list(fill=NA))) 

p4
  
```


```{r}
plot_mod17 = ggplot(data = field_gcc_ndvi17, aes(x = shrub_ba_ha, y = mean_ndvi_10m)) + geom_point(size = 2) +
    geom_line(aes(y = pred_mod17), linetype = 1, size = 2) + 
    geom_ribbon( aes(ymin = lcl_mod17, ymax = ucl_mod17, color = NULL, show.legend = FALSE), alpha = .15) +
    geom_line(aes(y= lcl_mod17), linetype = 'longdash', size = 1) + 
    geom_line(aes(y=ucl_mod17), linetype='longdash', size = 1) +
    ylab("Mean NDVI") +
    labs(x=expression(Shrub~BA~(m^2/ha))) +
    reg_theme +  guides(color=guide_legend(override.aes=list(fill=NA))) 

plot_mod17
```



# Combine Summary output 

```{r}
model_sum1 = rbind(mod13_df3, mod14_df3)
model_sum2 = rbind(mod15_df3, mod16_df3)
model_sum3 = rbind(mod17_df3, mod18_df3)
model_sum4 = rbind(model_sum1, model_sum2)
model_sum5 = rbind(model_sum4, model_sum3)
model_sum5
```

```{r eval=FALSE, include=FALSE}
write.csv(model_sum5, '../outputs/model_summary/2020-06-15_vegetation-cover-gcc-ndvi.csv', row.names = F)

```

# Combine Summary output lm

```{r}
fit_sum1 = rbind(fit1_df3, fit2_df3)
fit_sum2 = rbind(fit3_df3, fit4_df3)
fit_sum3 = rbind(fit_sum1, fit_sum2)

fit_sum3
```

```{r eval=FALSE, include=FALSE}
write.csv(fit_sum3, '../outputs/model_summary/2020-07-13_vegetation-cover-gcc-ndvi_lm.csv', row.names = F)

```


# Manuscript Figures 

## Part 3: Vegetation  cover


```{r fig.height=7, fig.width=6}

grid_plot_veg = cowplot::plot_grid(plot_mod13, plot_mod18, plot_mod14, plot_mod16, plot_mod15, plot_mod17,    labels = c("A", "B", "C", "D", "E", "F"), align = "hv", ncol= 2) 
grid_plot_veg

```

```{r eval=FALSE, include=FALSE}
ggsave("../figures/2020-06-07_vegcover-gcc-ndvi.jpeg", plot = grid_plot_veg, width = 6, height = 7, units = c("in"), dpi=600 )
```


```{r fig.height=7, fig.width=6}

grid_plot_veg1 = cowplot::plot_grid(plot_mod13, plot_mod18, plot_mod14, plot_mod16, plot_mod15, plot_mod17,    labels = c("A", "B", "C", "D", "E", "F"), align = "hv", ncol= 2) +
  draw_label("*", x = .95, y = .76, size = 36, fontface = "bold") +
  draw_label("*", x = .45, y = .76, size = 36, fontface = "bold") +
  draw_label("*", x = .95, y = .43, size = 36, fontface = "bold") +
  draw_label("*", x = .45, y = .43, size = 36, fontface = "bold") +
  draw_label("*", x = .45, y = .10, size = 36, fontface = "bold")
grid_plot_veg1

```

```{r eval=FALSE, include=FALSE}
ggsave("../figures/2020-06-07_vegcover-gcc-ndvi_sig.jpeg", plot = grid_plot_veg1, width = 6, height = 7, units = c("in"), dpi=600 )
```



```{r fig.height=5, fig.width=6}

grid_plot_veg2 = cowplot::plot_grid(plot_mod14, plot_mod16, plot_mod15, plot_mod17,    labels = c("A", "B", "C", "D"), align = "hv", ncol= 2) +
  draw_label("*", x = .95, y = .66, size = 36, fontface = "bold") +
  draw_label("*", x = .45, y = .66, size = 36, fontface = "bold") +
  draw_label("*", x = .95, y = .15, size = 36, fontface = "bold") +
  draw_label("*", x = .45, y = .15, size = 36, fontface = "bold")
grid_plot_veg2

```


```{r eval=FALSE, include=FALSE}
ggsave("../figures/2020-06-15_BA-gcc-ndvi_sig.jpeg", plot = grid_plot_veg2, width = 6, height = 5, units = c("in"), dpi=600 )
```

## lm Figure
```{r fig.height=5, fig.width=6}

lm_grid_veg1 = cowplot::plot_grid(p1, p2, p3, p4,    labels = c("A", "B", "C", "D"), align = "hv", ncol= 2) +
  draw_label("*", x = .95, y = .66, size = 36, fontface = "bold") +
  draw_label("*", x = .45, y = .66, size = 36, fontface = "bold") +
  draw_label("*", x = .95, y = .15, size = 36, fontface = "bold") +
  draw_label("*", x = .45, y = .15, size = 36, fontface = "bold")
lm_grid_veg1

```


```{r eval=FALSE, include=FALSE}
ggsave("../figures/2020-07-13_BA-gcc-ndvi_lm.jpeg", plot = lm_grid_veg1, width = 6, height = 5, units = c("in"), dpi=600 )
```