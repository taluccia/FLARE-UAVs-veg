---
title: "UAV-EdgeEffect-Analysis"
author: "Anna Talucci"
date: "5/13/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Overview


# Pakcages
```{r}
library(tidyr)
library(dplyr)
library(ggplot2)
library(stringr)
library(lme4)
library(cowplot)
library(lme4)
library(lsmeans)
library(DHARMa)
library(multcomp)
library(car)

```


# Field Data
```{r}
field_data = read.csv("../data/field_subset/field_data_all.csv")
```

```{r}
head(field_data)
```

## field Plot sizes

```{r}
field_data %>% group_by(site, transect) %>% 
  summarise(min(shrub_plot_area))
```

```{r}
field_data %>% group_by(site, transect) %>% 
  summarise(max(shrub_plot_area))
```

```{r}
field_data %>% group_by(site, transect) %>% 
  summarise(min(tree_radius))
```

```{r}
field_data %>% group_by(site, transect) %>% 
  summarise(max(tree_radius))
```

# UAV Data

```{r}
gcc_all = read.csv("../data/extracted_data/gcc_all.csv", strip.white = TRUE)
ndvi_all = read.csv("../data/extracted_data/2020-05-20_ndvi_all_pix4D.csv", strip.white = TRUE)
```

```{r}
head(gcc_all)
head(ndvi_all)
```

# Combine Field and UAV data

```{r}
gcc_ndvi = merge(gcc_all, ndvi_all, by="ID")
gcc_ndvi
field_gcc = merge(field_data, gcc_all, by="ID") 
field_gcc
field_gcc_ndvi = merge(field_data, gcc_ndvi,  "ID")
field_gcc_ndvi
```

# burn_year as factor

```{r}
field_gcc$burn_year = as.factor(field_gcc$burn_year)
field_gcc_ndvi$burn_year = as.factor(field_gcc_ndvi$burn_year)

str(field_gcc)
str(field_gcc_ndvi)
```



# Define graph Theme and color Palette 

```{r}
comp_theme = theme_bw() + theme(legend.position = "none") +  
  theme(panel.grid.major = element_blank()) +
    theme(axis.title.y = element_text(size = 11, hjust = 0.5, vjust = 1.1),
        axis.text.x = element_text(size = 10, color = "black"),
        axis.text.y = element_text(size = 10, color = "black"),
        axis.line = element_line(colour = "black"))
```
 
```{r}

reg_theme = theme_bw() + theme(legend.position = "none") +
  theme(plot.margin = unit(c(t = 0.3, r = 0.3, b = 0.3, l = 0.1), "cm")) +
  theme(axis.title.x = element_text(size = 11, hjust = 0.5, vjust = -0.1),
        axis.title.y = element_text(size = 11, hjust = 0.5, vjust = 1.1),
        axis.text.x = element_text(size = 10, color = "black"),
        axis.text.y = element_text(size = 10, color = "black"),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"))

```

```{r}
cbbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
```

# Summary stats
```{r}
field_gcc %>% group_by(burn_unburn) %>% summarise(mean=mean(mean_gcc_10m), sd=sd(mean_gcc_10m), min=min(mean_gcc_10m), max=max(mean_gcc_10m))
```

```{r}
field_gcc_ndvi %>% group_by(burn_unburn) %>% summarise(mean=mean(mean_ndvi_10m), sd=sd(mean_ndvi_10m), min=min(mean_ndvi_10m), max=max(mean_ndvi_10m))
```

# Part 2:  Post-fire

## 7. Model: GCC burn/unburned
```{r}
mod7 = glm(mean_gcc_10m ~ burn_unburn, data = field_gcc, family = gaussian)
```

### Residuals with DHARMa
```{r, include=FALSE}
mod7.res = simulateResiduals(fittedModel = mod7, n = 500)
mod7.res$scaledResiduals
mod7.res$scaledResidualsNormal
```

In the plot below we are looking for the points in the QQ plot to fall along the RED linen. In the Residuals vs.predicted plot were are looking for the lines to be relatively horizontal. All looks good. 
```{r}
plotSimulatedResiduals(simulationOutput = mod7.res)
```

```{r}
testDispersion(mod7.res)
```

### Summary
```{r}
summary(mod7)
```
#### Summary Data Frame

```{r}

mod7_df = data.frame(summary(lsmeans(mod7, revpairwise ~ burn_unburn, type = "response", infer = TRUE)))
mod7_df 
mod7_df1 = mod7_df %>% 
  mutate(model="mod7") %>% 
  mutate(response = "GCC") %>% 
  rename(explanatory = lsmeans.burn_unburn, estimate = lsmeans.lsmean, se = lsmeans.SE, lcl = lsmeans.asymp.LCL, ucl = lsmeans.asymp.UCL, contrast = contrasts.contrast) %>% 
  
  
  dplyr::select(model:response, explanatory:se, lcl:contrasts.SE, contrasts.z.ratio:contrasts.p.value)
mod7_df1
```

```{r}
( mod7_contrast = data.frame(summary(lsmeans(mod7, revpairwise ~ burn_unburn),type = "response", infer = TRUE)$contrasts))

mod7_contrast1 = mod7_contrast %>%  mutate(response = "GCC")  
 
```

### Data for graph

```{r}
(mod7_graph = data.frame(summary(lsmeans(mod7, pairwise ~ burn_unburn),type = "response")))
```


```{r}
levels(mod7_graph$lsmeans.burn_unburn)[levels(mod7_graph$lsmeans.burn_unburn)=="burned"] = "Burned"
levels(mod7_graph$lsmeans.burn_unburn)[levels(mod7_graph$lsmeans.burn_unburn)=="unburned"] = "Unburned"

( mod7_graph1 = dplyr::select(mod7_graph, lsmeans.burn_unburn:lsmeans.asymp.UCL))



names(mod7_graph1)[1:6] = c("burn_unburn", "response", "se", "df", "lcl", "ucl")
mod7_graph1 = data.frame(mod7_graph1)
mod7_graph1

```

### Graph

```{r}
plot_mod7 = ggplot(data = mod7_graph1, aes(x = burn_unburn, y = response, color = burn_unburn) ) + 
   geom_errorbar(width = .2, lwd = .75, aes(ymin = lcl, ymax = ucl), position = position_dodge(width = .75)) + 
geom_point(size = 3, position = position_dodge(width = .75)) + 
  labs(x=(NULL), y= "Mean GCC") +
  scale_color_manual(values = c("#E69F00", "#009E73")) + 
  comp_theme

plot_mod7 
```

#### Box plot

```{r}
boxplot_mod7 = ggplot(field_gcc, aes(x=burn_unburn, y=mean_gcc_10m, color = burn_unburn, fill=burn_unburn) ) + # define plot axes
geom_boxplot(fill = "white") +
  geom_dotplot(binaxis = "y", stackdir = "center", dotsize = .5) + 
stat_summary(fun.y = mean, geom= "point", shape = 18, size = 5) + 
labs(x=(NULL), y= "Mean GCC") +
  scale_color_manual(values = c("#E69F00", "#009E73")) + 
  comp_theme

boxplot_mod7

```



## 8. Model: NDVI burn/unburned
```{r}
mod8 = glm(mean_ndvi_10m ~ burn_unburn, data = field_gcc_ndvi, family = gaussian)
```

### Residuals with DHARMa
```{r, include=FALSE}
mod8.res = simulateResiduals(fittedModel = mod8, n = 500)
mod8.res$scaledResiduals
mod8.res$scaledResidualsNormal
```

In the plot below we are looking for the points in the QQ plot to fall along the RED linen. In the Residuals vs.predicted plot were are looking for the lines to be relatively horizontal. All looks good. 
```{r}
plotSimulatedResiduals(simulationOutput = mod8.res)
```

```{r}
testDispersion(mod8.res)
```

### Summary
```{r}
summary(mod8)
```

#### Summary Dataframe
```{r}
mod8_df = data.frame(summary(lsmeans(mod8, revpairwise ~ burn_unburn, type = "response", infer = TRUE, adjust = "tukey")))
mod8_df
mod8_df1 = mod8_df %>% 
  mutate(model="mod8") %>% 
  mutate(response = "NDVI") %>% 
  rename(explanatory = lsmeans.burn_unburn, estimate = lsmeans.lsmean, se = lsmeans.SE, lcl = lsmeans.asymp.LCL, ucl = lsmeans.asymp.UCL, contrast = contrasts.contrast) %>% 
  dplyr::select(model:response, explanatory:se, lcl:contrasts.SE, contrasts.z.ratio:contrasts.p.value)
mod8_df1
```

```{r}
( mod8_contrast = data.frame(summary(lsmeans(mod8, revpairwise ~ burn_unburn),type = "response", infer = TRUE)$contrasts))
mod8_contrast1 = mod8_contrast %>%  mutate(response = "NDVI") 
```

### Data for graph

```{r}
(mod8_graph = data.frame(summary(lsmeans(mod8, pairwise ~ burn_unburn),type = "response")))
```
```{r}
mod8_df = data.frame(summary(lsmeans(mod8, revpairwise ~ burn_unburn, type = "response", infer = TRUE, adjust = "tukey")))
mod8_df = mod8_df %>% mutate(model="mod8") %>% mutate(response = "NDVI") %>% rename(explanatory = lsmeans.burn_unburn, estimate = lsmeans.lsmean, se = lsmeans.SE, lcl = lsmeans.asymp.LCL, ucl = lsmeans.asymp.UCL, contrast = contrasts.contrast) %>% dplyr::select(model:response, explanatory:se, lcl:contrasts.SE)
mod8_df
```

```{r}
levels(mod8_graph$lsmeans.burn_unburn)[levels(mod8_graph$lsmeans.burn_unburn)=="burned"] = "Burned"
levels(mod8_graph$lsmeans.burn_unburn)[levels(mod8_graph$lsmeans.burn_unburn)=="unburned"] = "Unburned"

( mod8_graph1 = dplyr::select(mod8_graph, lsmeans.burn_unburn:lsmeans.asymp.UCL))



names(mod8_graph1)[1:6] = c("burn_unburn", "response", "se", "df", "lcl", "ucl")
mod8_graph1 = data.frame(mod8_graph1)
mod8_graph1

```

### Graph

```{r}
plot_mod8 = ggplot(data = mod8_graph1, aes(x = burn_unburn, y = response, color = burn_unburn) ) + 
   geom_errorbar(width = .2, lwd = .75, aes(ymin = lcl, ymax = ucl), position = position_dodge(width = .75)) + 
geom_point(size = 3, position = position_dodge(width = .75)) + 
  labs(x=(NULL), y= "Mean NDVI") +
  scale_color_manual(values = c("#E69F00", "#009E73")) + 
  comp_theme

plot_mod8 
```

```{r}
boxplot_mod8 = ggplot(field_gcc_ndvi, aes(x=burn_unburn, y=mean_ndvi_10m, color = burn_unburn, fill = burn_unburn) ) + # define plot axes
geom_boxplot(fill = "white") +
  geom_dotplot(binaxis = "y", stackdir = "center",
dotsize = .5) + # Dotplot by group
stat_summary(fun.y = mean, geom= "point", shape = 18, size = 5) + # Add means to the plot
labs(x=(NULL), y= "Mean NDVI") +
  scale_color_manual(values = c("#E69F00", "#009E73")) + 
  comp_theme

boxplot_mod8

```


## 11. Model: GCC distance from unburned edge 
```{r}
mod11 = glm(mean_gcc_10m ~ plot_dis, data = field_gcc, family = gaussian)
```

### Residuals with DHARMa
```{r, include=FALSE}
mod11.res = simulateResiduals(fittedModel = mod11, n = 500)
mod11.res$scaledResiduals
mod11.res$scaledResidualsNormal
```

In the plot below we are looking for the points in the QQ plot to fall along the RED linen. In the Residuals vs.predicted plot were are looking for the lines to be relatively horizontal. All looks good. 
```{r}
plotSimulatedResiduals(simulationOutput = mod11.res)
```

```{r}
testDispersion(mod11.res)
```

### Summary
```{r}
summary(mod11)
```

#### Summary Dataframe

```{r}
mod11_df = data.frame(summary(mod11)$coefficients[,], confint(mod11), deviance(mod11), summary(mod11)$null.deviance, extractAIC(mod11))
mod11_df
mod11_df2 = tibble::rownames_to_column(mod11_df, "coefficent")
mod11_df3 = mod11_df2 %>% 
  mutate(model = "mod11") %>% 
  mutate(response = "GCC" ) %>%  
  rename(estimate = Estimate, se = Std..Error, t_value = t.value,  p_value = Pr...t.., lcl = X2.5.., ucl = X97.5.., deviance=deviance.mod11., null_deviance= summary.mod11..null.deviance, AIC = extractAIC.mod11.) %>% dplyr::select(model:response, coefficent:AIC)
mod11_df3
```

### Predicted data for for graph
```{r}
preddat_mod11 = data.frame(plot_dis = field_gcc$plot_dis)

head(preddat_mod11)

pred_mod11 = predict(mod11, newdata = preddat_mod11, se.fit = TRUE)

UL_mod11 = with(pred_mod11, fit + 2*se.fit)
LL_mod11 = with(pred_mod11, fit - 2*se.fit)

field_gcc11 = mutate(field_gcc, pred_mod11 = (pred_mod11$fit), 
               ucl_mod11 = (UL_mod11), 
               lcl_mod11 = (LL_mod11))
```


### Graph  

```{r}
plot_mod11 = ggplot(data = field_gcc11, aes(x = plot_dis, y = mean_gcc_10m)) + 
    geom_point(size = 2) +  
    geom_line(aes(y = pred_mod11), linetype = 1, size = 2) + 
    geom_ribbon( aes(ymin = lcl_mod11, ymax = ucl_mod11, color = NULL, show.legend = FALSE), alpha = .15) +
    geom_line(aes(y= lcl_mod11), linetype = 'longdash', size = 1) + 
    geom_line(aes(y=ucl_mod11), linetype='longdash', size = 1) +
    geom_vline(xintercept=0, linetype="dashed", color = "#9C270E", size = 1) +
    ylab("Mean GCC") +
    xlab("Distance from the unburned edge \n(m)")  +
    reg_theme +  guides(color=guide_legend(override.aes=list(fill=NA))) +
    scale_y_continuous(breaks = c(0.34, 0.36, 0.38, 0.40, 0.42)) +
    scale_x_continuous(breaks = c(-50, 0, 50, 100, 150, 200))

plot_mod11
```


## 12.  Model: NDVI distance from edge
```{r}
mod12 = glm(mean_ndvi_10m ~ plot_dis, data = field_gcc_ndvi, family = gaussian)
```

### Residuals with DHARMa
```{r, include=FALSE}
mod12.res = simulateResiduals(fittedModel = mod12, n = 500)
mod12.res$scaledResiduals
mod12.res$scaledResidualsNormal
```

In the plot below we are looking for the points in the QQ plot to fall along the RED linen. In the Residuals vs.predicted plot were are looking for the lines to be relatively horizontal. All looks good. 
```{r}
plotSimulatedResiduals(simulationOutput = mod12.res)
```

```{r}
testDispersion(mod12.res)
```

### Summary
```{r}
summary(mod12)
```

#### Summary Dataframe

```{r}
mod12_df = data.frame(summary(mod12)$coefficients[,], confint(mod12), deviance(mod12), summary(mod12)$null.deviance, extractAIC(mod12))
mod12_df
mod12_df2 = tibble::rownames_to_column(mod12_df, "coefficent")
mod12_df3 = mod12_df2 %>% 
  mutate(model = "mod12") %>% 
  mutate(response = "NDVI" ) %>%  
  rename(estimate = Estimate, se = Std..Error, t_value = t.value,  p_value = Pr...t.., lcl = X2.5.., ucl = X97.5.., deviance=deviance.mod12., null_deviance= summary.mod12..null.deviance, AIC = extractAIC.mod12.) %>% dplyr::select(model:response, coefficent:AIC)
mod12_df3
```



```{r}
preddat_mod12 = data.frame(plot_dis = field_gcc_ndvi$plot_dis)

head(preddat_mod12)

pred_mod12 = predict(mod12, newdata = preddat_mod12, se.fit = TRUE)

UL_mod12 = with(pred_mod12, fit + 2*se.fit)
LL_mod12 = with(pred_mod12, fit - 2*se.fit)

field_gcc_ndvi12 = mutate(field_gcc_ndvi, pred_mod12 = (pred_mod12$fit), 
               ucl_mod12 = (UL_mod12), 
               lcl_mod12 = (LL_mod12))
```

### Graph  

```{r}
plot_mod12 = ggplot(data = field_gcc_ndvi12, aes(x = plot_dis, y = mean_ndvi_10m)) + 
    geom_point(size = 2) +  
    geom_line(aes(y = pred_mod12), linetype = 1, size = 2) + 
    geom_ribbon( aes(ymin = lcl_mod12, ymax = ucl_mod12, color = NULL, show.legend = FALSE), alpha = .15) +
    geom_line(aes(y= lcl_mod12), linetype = 'longdash', size = 1) + 
    geom_line(aes(y=ucl_mod12), linetype='longdash', size = 1) +
    geom_vline(xintercept=0, linetype="dashed", color = "#9C270E", size = 1) +
    ylab("Mean NDVI") +
    xlab("Distance from the unburned edge \n(m)")  +
    reg_theme + guides(color=guide_legend(override.aes=list(fill=NA))) +
    scale_x_continuous(breaks = c(-50, 0, 50, 100, 150, 200))

plot_mod12
```

# Summary output Combine
## Burned-Unburned

```{r}
burn_unburn_sum = rbind(mod7_df1, mod8_df1)
burn_unburn_sum
```

```{r eval=FALSE, include=FALSE}
write.csv(burn_unburn_sum, '../outputs/model_summary/2020-05-27_burn-unburn-summary.csv', row.names = F)

```


```{r}
burn_unburn_contrast = rbind(mod7_contrast1, mod8_contrast1)
burn_unburn_contrast
```

```{r eval=FALSE, include=FALSE}
write.csv(burn_unburn_contrast, '../outputs/model_summary/2020-06-01_burn-unburn-contrast.csv', row.names = F)

```

```{r}
edge_sum = rbind(mod11_df3, mod12_df3)
edge_sum
```

```{r eval=FALSE, include=FALSE}
write.csv(edge_sum, '../outputs/model_summary/2020-05-27_distance-edge-summary.csv', row.names = F)

```


# Manuscript figures

## Part 2: Post-fire

### Burned vs. Unburned + Burn Year
```{r fig.height=6, fig.width=6}

grid_plot_burn = cowplot::plot_grid(plot_mod7, plot_mod8, plot_mod9, plot_mod10, labels = c("A", "B", "C", "D"), align = "hv", ncol= 2) 
grid_plot_burn

```

```{r eval=FALSE, include=FALSE}
ggsave("../figures/2020-05-20_burn-unburn-year.jpeg", plot = grid_plot_burn, width = 6, height = 6, units = c("in"), dpi=600 )
```

## Burn and unburned only
```{r fig.height=3, fig.width=6}

grid_plot_burn_un = cowplot::plot_grid(plot_mod7, plot_mod8, labels = c("A", "B", "C", "D"), align = "hv", ncol= 2) 
grid_plot_burn_un

```

```{r eval=FALSE, include=FALSE}
ggsave("../figures/2020-05-27_burn-unburn-only.jpeg", plot = grid_plot_burn_un, width = 6, height = 3, units = c("in"), dpi=600 )
```


### Boxplots burn/unburn
```{r fig.height=6, fig.width=6}

grid_boxplot_burn = cowplot::plot_grid(boxplot_mod7, boxplot_mod8, boxplot_mod9, boxplot_mod10, labels = c("A", "B", "C", "D"), align = "hv", ncol= 2) 
grid_boxplot_burn

```

```{r eval=FALSE, include=FALSE}
ggsave("../figures/2020-05-20_BOX-burn-unburn-year.jpeg", plot = grid_boxplot_burn, width = 6, height = 6, units = c("in"), dpi=600 )
```

### Boxplots burn/unburn
```{r fig.height=3, fig.width=6}

grid_boxplot_burn_un = cowplot::plot_grid(boxplot_mod7, boxplot_mod8, labels = c("A", "B", "C", "D"), align = "hv", ncol= 2) 
grid_boxplot_burn_un

```

```{r eval=FALSE, include=FALSE}
ggsave("../figures/2020-05-27_BOX-burn-unburn-only.jpeg", plot = grid_boxplot_burn_un, width = 6, height = 3, units = c("in"), dpi=600 )
```

### Distance from unburned edge

```{r fig.height=3, fig.width=6}

grid_plot_edge = cowplot::plot_grid(plot_mod11, plot_mod12, labels = c("A", "B"), align = "hv", ncol= 2) 
grid_plot_edge

```

```{r eval=FALSE, include=FALSE}
ggsave("../figures/2020-05-20_distance_edge_pts.jpeg", plot = grid_plot_edge, width = 6, height = 3, units = c("in"), dpi=600 )
```


```{r fig.height=3, fig.width=6}

grid_plot_edge1 = cowplot::plot_grid(plot_mod11, plot_mod12, labels = c("A", "B"), align = "hv", ncol= 2) +
  draw_label("*", x = .95, y = .87, size = 36, fontface = "bold") +
  draw_label("*", x = .45, y = .87, size = 36, fontface = "bold") 
grid_plot_edge1

```

```{r eval=FALSE, include=FALSE}
ggsave("../figures/2020-05-29_distance_edge_pts_sig.jpeg", plot = grid_plot_edge1, width = 6, height = 3, units = c("in"), dpi=600 )
```