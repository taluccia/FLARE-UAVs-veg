---
title: "UAV-Biomass-Analysis"
author: "Anna Talucci"
date: "5/13/2020"
output: html_document
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Overview


# Pakcages
```{r}
library(tidyr)
library(dplyr)
library(ggplot2)
library(stringr)
library(lme4)
library(cowplot)
library(lme4)
library(lsmeans)
library(DHARMa)
library(rcompanion)
library(qpcR)
```

# Functions

```{r}
numextract <- function(string){ 
  str_extract(string, "\\-*\\d+\\.*\\d*")
} 

```

# Field Data
```{r}
field_data = read.csv("../data/field_subset/field_data_all.csv")
```

```{r}
head(field_data)
```

## field Plot sizes

```{r}
field_data %>% group_by(site, transect) %>% 
  summarise(min(shrub_plot_area))
```

```{r}
field_data %>% group_by(site, transect) %>% 
  summarise(max(shrub_plot_area))
```

```{r}
field_data %>% group_by(site, transect) %>% 
  summarise(min(tree_radius))
```

```{r}
field_data %>% group_by(site, transect) %>% 
  summarise(max(tree_radius))
```

# UAV Data

```{r}
gcc_all = read.csv("../data/extracted_data/gcc_all.csv", strip.white = TRUE)
ndvi_all = read.csv("../data/extracted_data/2020-08-10_ndvi_all_pix4D.csv", strip.white = TRUE)
```

```{r}
head(gcc_all)
head(ndvi_all)
```
# Pull out GCC and NDVI by buffer size

```{r}
gcc_long = gcc_all %>% 
  dplyr::select(ID:mean_gcc_10m) %>%
  pivot_longer(-ID, names_to = "buffer", values_to = "gcc") %>%
  mutate(buf_res = numextract(buffer))

gcc_long
```

```{r}
ndvi_long = ndvi_all %>% 
  dplyr::select(ID:mean_ndvi_10m) %>%
  pivot_longer(-ID, names_to = "buffer", values_to = "ndvi") %>%
  mutate(buf_res = numextract(buffer))

ndvi_long
```

# Combine Field and UAV data

```{r}
gcc_ndvi = merge(gcc_all, ndvi_all, by="ID")
gcc_ndvi
field_gcc = merge(field_data, gcc_all, by="ID") 
field_gcc
field_gcc_ndvi = merge(field_data, gcc_ndvi,  "ID")
field_gcc_ndvi
```
# Field data +  long data
```{r}
field_gcc_long = merge(field_data, gcc_long, by="ID")

field_gcc_long1 = field_gcc_long %>% 
  dplyr::select(ID:burn_year, live_woody_biomass_C_g_m, buffer:buf_res) %>%
  mutate(res_meters = ifelse(buf_res %in% 25, "25cm",
                                    ifelse(buf_res %in% 50, "50cm",
                                    ifelse(buf_res %in% 1, "1m",
                                    ifelse(buf_res %in% 3, "3m",
                                    ifelse(buf_res %in% 5, "5m", "10m")))))) %>%
  mutate(res_meters = factor(res_meters, levels = c("25cm", "50cm", "1m", "3m", "5m", "10m"))) %>%
  mutate(biomass_log = log(live_woody_biomass_C_g_m))

head(field_gcc_long1)
```

```{r}
field_ndvi_long = merge(field_data, ndvi_long, by="ID")

field_ndvi_long1 = field_ndvi_long %>% 
  dplyr::select(ID:burn_year, live_woody_biomass_C_g_m, buffer:buf_res) %>%
  mutate(res_meters = ifelse(buf_res %in% 25, "25cm",
                                    ifelse(buf_res %in% 50, "50cm",
                                    ifelse(buf_res %in% 1, "1m",
                                    ifelse(buf_res %in% 3, "3m",
                                    ifelse(buf_res %in% 5, "5m", "10m")))))) %>%
  mutate(res_meters = factor(res_meters, levels = c("25cm", "50cm", "1m", "3m", "5m", "10m"))) %>%
  mutate(biomass_log = log(live_woody_biomass_C_g_m))

head(field_ndvi_long1)
```

# Variables as factor

```{r}
field_gcc$burn_year = as.factor(field_gcc$burn_year)
field_gcc_ndvi$burn_year = as.factor(field_gcc_ndvi$burn_year)

str(field_gcc)
str(field_gcc_ndvi)
```

```{r}
field_gcc_long$burn_year = as.factor(field_gcc_long$burn_year)
field_ndvi_long$burn_year= as.factor(field_ndvi_long$burn_year)
field_gcc_long$buf_res = as.factor(field_gcc_long$buf_res)
field_ndvi_long$buf_res = as.factor(field_ndvi_long$buf_res)
```



# Define graph Theme and color Palette 

```{r}
comp_theme = theme_bw() + theme(legend.position = "none") +  
  theme(panel.grid.major = element_blank()) +
    theme(axis.title.y = element_text(size = 11, hjust = 0.5, vjust = 1.1),
        axis.text.x = element_text(size = 10, color = "black"),
        axis.text.y = element_text(size = 10, color = "black"),
        axis.line = element_line(colour = "black"))
```
theme(panel.grid = element_blank(),
        panel.border = element_blank())
```{r}

reg_theme = theme_bw() + theme(legend.position = "none") +
  theme(plot.margin = unit(c(t = 0.3, r = 0.3, b = 0.3, l = 0.1), "cm")) +
  theme(axis.title.x = element_text(size = 10, hjust = 0.5, vjust = -0.2),
        axis.title.y = element_text(size = 10, hjust = 0.5, vjust = 1.1),
        axis.text.x = element_text(size = 9, color = "black"),
        axis.text.y = element_text(size = 9, color = "black"),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"))

```

```{r}

blank_xy_theme = theme_bw() + theme(legend.position = "none") +
  theme(plot.margin = unit(c(t = 0.1, r = 0.1, b = 0.6, l = 0.6), "cm")) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"))


```

 
```{r}

blank_x_theme = theme_bw() + theme(legend.position = "none") +
  theme(plot.margin = unit(c(t = 0.3, r = 0.3, b = 0.3, l = 0.1), "cm")) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_text(size = 11, hjust = 0.5, vjust = 1.1),
        axis.text.x = element_blank(),
        axis.text.y = element_text(size = 10, color = "black"),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"))

```

 
```{r}

blank_y_theme = theme_bw() + theme(legend.position = "none") +
  theme(plot.margin = unit(c(t = 0.3, r = 0.3, b = 0.3, l = 0.1), "cm")) +
  theme(axis.title.x = element_text(size = 11, hjust = 0.5, vjust = -0.1),
        axis.title.y = element_blank(),
        axis.text.x = element_text(size = 10, color = "black"),
        axis.text.y = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"))

```

```{r}
cbbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
```

```{r}
min(field_gcc$woody_biomass_C_g_m)
max(field_gcc$woody_biomass_C_g_m)

```

```{r}
min(field_gcc$live_woody_biomass_C_g_m)
max(field_gcc$live_woody_biomass_C_g_m)

```

# Analysis: Biomass ~ GCC


```{r}
head(field_gcc_long1)
```


```{r}
fit1 = lm(biomass_log ~ gcc + res_meters + gcc:res_meters, data = field_gcc_long1)
```

```{r}
summary(fit1)
```
```{r}
summary(fit1)$r.squared 
```

#### Residuals
```{r}
# Get the fitted value for each observation
field_gcc_long1$fit1 = fitted(fit1)
# Get the residuals of the model
field_gcc_long1$res1 = residuals(fit1)
```

```{r}
qplot(x = fit1, y = res1, data = field_gcc_long1,
main = "Residuals vs Fitted Values")
```

```{r}
qplot(x = gcc, y = res1, data = field_gcc_long1,
xlab = "gcc",
ylab = "Residuals",
main = "Residuals vsgcc")
```
```{r}
qplot(x = factor(1), y = res1, data = field_gcc_long1, geom = "boxplot")
```

```{r}
qqnorm(field_gcc_long1$res1, main = "Normal QQ Plot of Residuals")
qqline(field_gcc_long1$res1) # add reference line to the qq plot
```

```{r}
plot(fit1, which = 1) # residual vs fitted values
```

```{r}
plot(fit1, which = 2) # qqnorm plot of residuals
```
#Predicted Values for Figures
We want to generate figure that shows the relationship between fire severity and Beetle outbreak severity. We will generate scatter plots of the raw data and then calculate predicted values from the models to graph a line showing the relationship between the response, surface fire effect, and the explanatory, proportion of beetle killed trees. There will be two lines each representing moderate and extreme burning conditions. 

## predic data

```{r}
preddat.biomass = data.frame(gcc = field_gcc_long1$gcc, res_meters = field_gcc_long1$res_meters)
head(preddat.biomass)

predbiomass = predict(fit1, newdata = preddat.biomass, se.fit = TRUE)

ucl = with(predbiomass, fit + 2*se.fit)
lcl = with(predbiomass, fit - 2*se.fit)

field_gcc_long1 = mutate(field_gcc_long1, predbiomass = preddat.biomass$fit)
```

### Plot

  stat_smooth(method = "lm", col = "black", alpha = .25) +
  + 
  scale_y_continuous(breaks = seq(0.3, 0.45, by = .05), name = "GCC (25cm)")

```{r fig.height=5, fig.width=6}
plot_fit1 = ggplot(data = field_gcc_long1, aes(x = gcc, y = biomass_log, color = factor(res_meters))) + 
    geom_point(size = 1) +  
  geom_smooth(method="lm") +
    labs(y=expression(C~mass~(g~C~m^-2))) +
  theme_bw() + theme(legend.position = "bottom") 

plot_fit1
  
```

```{r eval=FALSE, include=FALSE}
ggsave("../figures/2020-08-19_gcc-biomass-resolution.jpeg", plot = plot_fit1, width = 6, height = 5, units = c("in"), dpi=600 )
```

# Analysis: Biomass ~ NDVI


```{r}
head(field_ndvi_long1)
```


```{r}
fit2 = lm(biomass_log ~ ndvi + res_meters + ndvi:res_meters, data = field_ndvi_long1)
```

```{r}
summary(fit2)
```
```{r}
summary(fit2)$r.squared 
```

#### Residuals
```{r}
# Get the fitted value for each observation
field_ndvi_long1$fit2 = fitted(fit2)
# Get the residuals of the model
field_ndvi_long1$res2 = residuals(fit2)
```

```{r}
qplot(x = fit2, y = res2, data = field_ndvi_long1,
main = "Residuals vs Fitted Values")
```

```{r}
qplot(x = ndvi, y = res2, data = field_ndvi_long1,
xlab = "ndvi",
ylab = "Residuals",
main = "Residuals vs ndvi")
```
```{r}
qplot(x = factor(1), y = res2, data = field_ndvi_long1, geom = "boxplot")
```

```{r}
qqnorm(field_ndvi_long1$res2, main = "Normal QQ Plot of Residuals")
qqline(field_ndvi_long1$res2) # add reference line to the qq plot
```

```{r}
plot(fit2, which = 1) # residual vs fitted values
```

```{r}
plot(fit2, which = 2) # qqnorm plot of residuals
```


### Plot

```{r fig.height=5, fig.width=6}
plot_fit2 = ggplot(data = field_ndvi_long1, aes(x = ndvi, y = biomass_log, color = factor(res_meters))) + 
    geom_point(size = 1) +  
  geom_smooth(method="lm") +
    labs(y=expression(C~mass~(g~C~m^-2))) +
  theme_bw() + theme(legend.position = "bottom") 

plot_fit2
  
```

```{r eval=FALSE, include=FALSE}
ggsave("../figures/2020-08-19_ndvi-biomass-resolution.jpeg", plot = plot_fit2, width = 6, height = 5, units = c("in"), dpi=600 )
```




##### Summary Dataframe

```{r}
mod1_df = data.frame(summary(mod1)$coefficients[,], confint(mod1), deviance(mod1), summary(mod1)$null.deviance, extractAIC(mod1))
mod1_df
mod1_df2 = tibble::rownames_to_column(mod1_df, "coefficent")
mod1_df2
mod1_df3 = mod1_df2 %>% 
  mutate(model = "mod1") %>% 
  mutate(response = "GCC" ) %>% 
  mutate(resolution = "25cm" ) %>% 
  mutate(rmse = RMSE(mod1)) %>%
  rename(estimate = Estimate, se = Std..Error, t_value = t.value,  p_value = Pr...t.., lcl = X2.5.., ucl = X97.5.., deviance=deviance.mod1., null_deviance= summary.mod1..null.deviance, AIC = extractAIC.mod1.) %>% 
  dplyr::select(model, response, resolution, coefficent:rmse)
mod1_df3
```


### Combine NDVI and GCC

```{r}
gcc_ndvi_data = rbind(gcc_combo2_data ,ndvi_combo2_data)
gcc_ndvi_data
```


### Save to  csv
```{r eval=FALSE, include=FALSE}
write.csv(gcc_ndvi_data, '../outputs/model_summary/2020-06-07_all-woody-biomass-gcc-ndvi-dAIC.csv', row.names = F)
```


# Manuscript Figures 

## GCC and NDVI

### Axis labels 3 columns
```{r fig.height=7, fig.width=6}

fig1 = cowplot::plot_grid(plot1, plot2, plot3, plot4, plot5, plot6, plot7, plot8, plot9, plot10, plot11, plot12, labels = "AUTO", align = "hv", label_size = 12, ncol= 3) + 
  theme(plot.margin = margin(0, 0, 0, 0)) 
  

fig1
```

```{r eval=FALSE, include=FALSE}
ggsave("../figures/2020-06-07_Biomass-live-woody-ndvi-gcc.jpeg", plot = fig1, width = 6, height = 7, units = c("in"), dpi=600 )
```

```{r fig.height=7, fig.width=6}

fig2 = cowplot::plot_grid(plot1, plot2, plot3, plot4, plot5, plot6, plot7, plot8, plot9, plot10, plot11, plot12, labels = "AUTO", align = "hv", label_size = 12, ncol= 3) + 
  theme(plot.margin = margin(0, 0, 0, 0)) +
  draw_label("*", x = .285, y = .59, size = 36, fontface = "bold") +
  draw_label("*", x = .285, y = .835, size = 36, fontface = "bold") +
  draw_label("*", x = .63, y = .59, size = 36, fontface = "bold") +
  draw_label("*", x = .63, y = .835, size = 36, fontface = "bold") +
  draw_label("*", x = .96, y = .59, size = 36, fontface = "bold") +
  draw_label("*", x = .96, y = .835, size = 36, fontface = "bold") +
  
  draw_label("*", x = .285, y = .34, size = 36, fontface = "bold") +
  draw_label("*", x = .285, y = .09, size = 36, fontface = "bold") +
  draw_label("*", x = .63, y = .34, size = 36, fontface = "bold") +
  draw_label("*", x = .63, y = .09, size = 36, fontface = "bold") +
  draw_label("*", x = .96, y = .34, size = 36, fontface = "bold") +
  draw_label("*", x = .96, y = .09, size = 36, fontface = "bold") 
  

fig2
```

```{r eval=FALSE, include=FALSE}
ggsave("../figures/2020-07-02_Biomass-live-woody-ndvi-gcc_sig.jpeg", plot = fig2, width = 6, height = 7, units = c("in"), dpi=600 )
```
